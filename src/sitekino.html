labmicro-21
Mural
Atividades
Pessoas
labmicro-21
Link do Meet
https://meet.google.com/lookup/c2wtiyawby
Próximas atividades
Nenhuma atividade para a próxima semana!
Visualizar tudo

Escreva um aviso para sua turma

Aviso: "pagina da disciplina em jkinoshi,"
Jorge Kinoshita
Criado em: 15:2615:26
pagina da disciplina em jkinoshi,

labmicro-21.html
HTML

Atividade: "Retornar 3 Propostas para P2 ; sendo a primeira proposta a mais prioritaria."
Jorge Kinoshita postou uma nova atividade: Retornar 3 Propostas para P2 ; sendo a primeira proposta a mais prioritaria.
Criado em: 23 de jul.23 de jul. Editado às 26 de jul.
Atividade: "*** printscreen (INDIVIDUAL)"
Jorge Kinoshita postou uma nova atividade: *** printscreen (INDIVIDUAL)
Criado em: 16 de jul.16 de jul.
Atividade: "*** relatorio + codigos fontes"
Jorge Kinoshita postou uma nova atividade: *** relatorio + codigos fontes
Criado em: 16 de jul.16 de jul.
Atividade: "*** planejamento (INDIVIDUAL)"
Jorge Kinoshita postou uma nova atividade: *** planejamento (INDIVIDUAL)
Criado em: 16 de jul.16 de jul.
Atividade: "relatorio + codigos fontes"
Jorge Kinoshita postou uma nova atividade: relatorio + codigos fontes
Criado em: 9 de jul.9 de jul.
Atividade: "printscreen (INDIVIDUAL)"
Jorge Kinoshita postou uma nova atividade: printscreen (INDIVIDUAL)
Criado em: 9 de jul.9 de jul.
Atividade: "planejamento (INDIVIDUAL)"
Jorge Kinoshita postou uma nova atividade: planejamento (INDIVIDUAL)
Criado em: 9 de jul.9 de jul.
Atividade: "planejamento (INDIVIDUAL)"
Jorge Kinoshita postou uma nova atividade: planejamento (INDIVIDUAL)
Criado em: 2 de jul.2 de jul.
Atividade: "printscreen (INDIVIDUAL)"
Jorge Kinoshita postou uma nova atividade: printscreen (INDIVIDUAL)
Criado em: 2 de jul.2 de jul.
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-07-23 sex 14:30 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="jk" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga421d1b">1. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-05-06 qui&gt; </span></span> . E1: Introducao a microprocessadores, com ênfase ao ARMv7.</a></li>
<li><a href="#orgcc144ec">2. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-05-13 qui&gt; </span></span> . E2: Programming Basics (cap2) + Data Processing Operations (cap3).</a></li>
<li><a href="#orgfc22a99">3. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-05-20 qui&gt; </span></span> . E3: Data Processing Operations (cap3).</a></li>
<li><a href="#org57f81a7">4. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-05-27 qui&gt; </span></span> . E4: Loads and Stores (cap4)</a></li>
<li><a href="#org7bc650b">5. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-06-10 qui&gt; </span></span> . E5: Conditional Executiong Loops (cap5).</a></li>
<li><a href="#org4a2ea09">6. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-06-17 qui&gt; </span></span> . E6: Subroutines (cap6)</a></li>
<li><a href="#org482c47a">7. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-06-24 qui&gt; </span></span> . P1 - Subroutines (cap6)</a></li>
<li><a href="#orgfdb82e5">8. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-07-01 qui&gt; </span></span> . E8: C compiler + assembler - juntar C com assembly.</a></li>
<li><a href="#org6ffdbac">9. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-07-08 qui&gt; </span></span> . E9: Hello World for bare metal</a></li>
<li><a href="#org6b83038">10. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-07-15 qui&gt; </span></span> . E10: interrupcao de tempo no Versatile emulado.</a></li>
<li><a href="#orgbb53af7">11. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-07-22 qui&gt; </span></span> . E11: Chaveamento entre 2 processos.</a></li>
<li><a href="#org71d684b">12. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-07-29 qui&gt; </span></span> . E12: Preparar projeto do curso a ser entregue ou terminar o chaveamento entre 2 processos.</a></li>
<li><a href="#orge222e91">13. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-08-05 qui&gt; </span></span> . E13: Preparar projeto do curso a ser entregue ou terminar o chaveamento entre 2 processos.</a></li>
<li><a href="#org0890049">14. <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-08-12 qui&gt; </span></span> . Prova2</a></li>
<li><a href="#org2cb9627">15. Avaliacao:</a></li>
<li><a href="#orge317ab0">16. Referências:</a></li>
</ul>
</div>
</div>
<p>
Lab. Microprocessadohres
PCS3732 -  Curso Cooperativo 
prof. Jorge Kinoshita.
</p>

<ol class="org-ol">
<li>quadrimestre 2021</li>
</ol>


<p>
turma: Quinta 13:30-17:10H
turma: Terca 13:30-17:10H
</p>

<p>
Aulas:
</p>

<div id="outline-container-orga421d1b" class="outline-2">
<h2 id="orga421d1b"><span class="section-number-2">1</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-05-06 qui&gt; </span></span> . E1: Introducao a microprocessadores, com ênfase ao ARMv7.</h2>
<div class="outline-text-2" id="text-1">
<div id="text-table-of-contents">
<ul>
<li><a href="#org1459d52">1.1. Explicar o curso, sequencia das aulas e avaliacao.</a></li>
<li><a href="#org142a68c">1.2. video sobre gnuarm, OPCIONAL</a></li>
<li><a href="#org3678533">1.3. Instale o docker:</a>
<ul>
<li><a href="#org9ba4aae">1.3.1. Instalacao no Windows</a></li>
</ul>
</li>
<li><a href="#orgdd652ca">1.4. gnuarm e código "hello world" seguinte post no linux-kernel-lab.</a>
<ul>
<li><a href="#orgc44024b">1.4.1. Possiveis problemas ao seguir o post</a></li>
</ul>
</li>
<li><a href="#org10b1de9">1.5. Usando o gnuarm, rode o programa da pagina 2-3 da apostila ARM Lab (item 2-2).</a>
<ul>
<li><a href="#org78d3dfc">1.5.1. Uma software interrupt</a></li>
</ul>
</li>
<li><a href="#org9b0252f">1.6. video sobre o processador ARM, OPCIONAL</a></li>
<li><a href="#orgd7eef51">1.7. referência: ARM Laboratory Exercises, cap. 1</a></li>
<li><a href="#orga33cd1d">1.8. Entregue o relatorio ateh o final do dia, INDIVIDUALMENTE.</a></li>
</ul>
</div>
</div>


<div id="outline-container-org1459d52" class="outline-3">
<h3 id="org1459d52"><span class="section-number-3">1.1</span> Explicar o curso, sequencia das aulas e avaliacao.</h3>
</div>
<div id="outline-container-org142a68c" class="outline-3">
<h3 id="org142a68c"><span class="section-number-3">1.2</span> video sobre gnuarm, OPCIONAL</h3>
<div class="outline-text-3" id="text-1-2">
<p>
O seguinte video explique como criar codigo usando o gnuarm. Nao eh obrigado assisti-lo, mas se o fizer, nao gaste muito tempo com isso pois lembre-se que voce deve entregar o relatorio ateh o final da aula. Alem disso, diversos topicos serao esclarecidos durante o curso. 
</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/ViNnfoE56V8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>
</div>



<div id="outline-container-org3678533" class="outline-3">
<h3 id="org3678533"><span class="section-number-3">1.3</span> Instale o docker:</h3>
<div class="outline-text-3" id="text-1-3">
<iframe width="560" height="315" src="https://www.youtube.com/embed/oRdvwUmWrOU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


<p>
O docker estah instalado em sua maquina? Se sim, pule isso.
</p>

<p>
Siga: <a href="https://phoenixnap.com/kb/how-to-install-docker-on-ubuntu-18-04">https://phoenixnap.com/kb/how-to-install-docker-on-ubuntu-18-04</a>
</p>

<p>
Dependendo de como vc. instalar as coisas vao dar errado&#x2026; por exemplo, para mim, a instalacao com snap nao funcionou; assim siga algum site como o acima, voltado para o ubuntu 18.4
</p>

<p>
Se acabou de instalar faca:
</p>

<pre class="example">
docker run hello-world
</pre>


<p>
Se nao rodou, voce ainda nao deve ter permissoes. Experimente:
</p>
<pre class="example">
sudo docker run hello-world
</pre>

<p>
Se nao rodou, vc nao instalou nada direito; mas se com "sudo" rodou veja: ( <a href="https://www.digitalocean.com/community/questions/how-to-fix-docker-got-permission-denied-while-trying-to-connect-to-the-docker-daemon-socket">https://www.digitalocean.com/community/questions/how-to-fix-docker-got-permission-denied-while-trying-to-connect-to-the-docker-daemon-socket</a> )
</p>


<pre class="example">
sudo groupadd docker
sudo usermod -aG docker ${USER}
</pre>

<p>
Voce terah que carregar o ambiente atraves de um reboot ou de um 
</p>
<pre class="example">
su -s ${USER}
</pre>

<p>
Seu usuario pertence ao grupo docker? Veja com:
</p>
<pre class="example">
groups
</pre>

<p>
Teste se tudo estah certo atraves de:
</p>

<pre class="example">
docker run hello-world
</pre>
</div>


<div id="outline-container-org9ba4aae" class="outline-4">
<h4 id="org9ba4aae"><span class="section-number-4">1.3.1</span> Instalacao no Windows</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
Raramente dah certo. Verifique se tem o WSL instalado. Se tiver problemas, provavelmente o kernel linux que roda no WSL não é binário-compatível com o gcc da imagem do Eric. Resolva isso usando uma VM ou rodando no linux diretamente. Outro problema: quando vc. for instalar algo no ubuntu / WSL, usando apt-get install, pode nao funcionar bem. A propria interface grafica dentro do WSL parece ter problemas. Enfim, nao se entuasiasme com o WSL e aproveite para aprender o Ubuntu sem sofrer com coisas desnecessarias.
</p>
</div>
</div>
</div>

<div id="outline-container-orgdd652ca" class="outline-3">
<h3 id="orgdd652ca"><span class="section-number-3">1.4</span> gnuarm e código "hello world" seguinte post no linux-kernel-lab.</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Faça com que o ARM imprima hello world de acordo com:
<a href="http://linux-kernel-lab.blogspot.com.br/2018/04/basics-on-arm-processor.html">http://linux-kernel-lab.blogspot.com.br/2018/04/basics-on-arm-processor.html</a>
Nesse post, vc. deve basicamente:
</p>
<ul class="org-ul">
<li>instalar a imagem do docker que contém todo o ambiente de desenvolvimento a ser usado em nosso curso:  <a href="#org6672ae5">16.2</a></li>
<li>rodar hello.c</li>
</ul>

<p>
Veja o seguinte video para a criacao da imagem do docker a ser usada em nosso curso:
</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/ituezb9QR54" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>
Este video apresenta como rodar um "hello-world.c" dentro do gnuarm:
</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/aVqQ0OcWFR0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


<p>
Se tiver interesse, veja as referencias <a href="#org5466d40">16.7</a>, <a href="#org501e09b">16.8</a>, <a href="#orgf3eda45">16.9</a>, <a href="#orga9e9683">16.10</a>.
</p>

<p>
Ao rodar o gdb, veja os registradores:
</p>
<pre class="example">
(gdb) înfo registers
(gdb) p $pc   -&gt; apresenta os $pc como numero decimal
(gdb) p/x $r0 -&gt; apresenta $r0 como numero hexadecimal
(gdb) p/x $cpsr -&gt; apresenta o $cpsr como numero hexadecimal.
</pre>
</div>



<div id="outline-container-orgc44024b" class="outline-4">
<h4 id="orgc44024b"><span class="section-number-4">1.4.1</span> Possiveis problemas ao seguir o post</h4>
<div class="outline-text-4" id="text-1-4-1">
</div>
<ol class="org-ol">
<li><a id="org7224f28"></a>Problema de permissao ao rodar ./build<sub>docker.sh</sub><br />
<div class="outline-text-5" id="text-1-4-1-1">
<p>
Este erro acontece nas maquinas do lab micro, mas nao costuma acontecer em seu computador pessoal. Para corrigir, na maquina do lab, faca:
</p>
<pre class="example">
~/gcc-arm$ sudo ./build_docker.sh
</pre>
</div>
</li>
<li><a id="orgdf769bf"></a>Nao tem permissao para criar arquivo hello.c em src<br />
<div class="outline-text-5" id="text-1-4-1-2">
<p>
Este erro acontece nas maquinas do lab micro, mas nao costuma acontecer em seu computador pessoal. Para corrigir, na maquina do lab, faca:
</p>
<pre class="example">
~/gcc-arm$ chmod 777 src
</pre>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-org10b1de9" class="outline-3">
<h3 id="org10b1de9"><span class="section-number-3">1.5</span> Usando o gnuarm, rode o programa da pagina 2-3 da apostila ARM Lab (item 2-2).</h3>
<div class="outline-text-3" id="text-1-5">
<iframe width="560" height="315" src="https://www.youtube.com/embed/5gwZ_LPRVqU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


<p>
Observe que vc. deverá colocar o programa no formato GNU. 
Uma forma de fazer isso é observar o hello.s e fazer as modificacoes. Em caso de dúvidas sobre as diretivas, consulte os manuais em <a href="https://sourcery.mentor.com/sgpp/lite/arm/portal/release830">https://sourcery.mentor.com/sgpp/lite/arm/portal/release830</a>; em particular consule o manual do GNU Assembler.
A modificação já feita do codigo assembly do item 2-2 fica assim no gnumarm:
</p>

<pre class="example">
---------------------------------------------------

	.text
	.globl main
main:
	MOV	r0, #15	     @ comentarios vem depois de @ ou entre /* ... */		
	MOV	r1, #20
	BL	firstfunc    @ desvia para funcao, coloca o enderenco de retorno em R14 ou LR (link register).		
	MOV	r0, #0x18		
	LDR	r1, =0x20026		
	SWI	0x123456		
firstfunc:
	ADD	r0, r0, r1		
	MOV	pc, lr	     @ retorna da funcao		
--------------------------------------------------
</pre>

<p>
Para isso vc. pode fazer:
</p>

<p>
gedit item-2-2.s
e fazer o copy and paste.
</p>

<p>
Experimente trocar ADD por ADDS para ver os registradores no CPSR
</p>
<pre class="example">
---------------------------------------------------

	.text
	.globl main
main:
	MOV	r0, #15	     @ comentarios vem depois de @ ou entre /* ... */		
	MOV	r1, #20
	BL	firstfunc    @ desvia para funcao, coloca o enderenco de retorno em R14 ou LR (link register).		
	MOV	r0, #0x18		
	LDR	r1, =0x20026		
	SWI	0x123456     @ no simulador (target sim) nao existe codigo a ser rodado quando se faz uma SWI sw. interrupt e portanto, gera erro.		
firstfunc:
	ADDS	r0, r0, r1   @ O S em ADDS coloca as flags N Z C V no CPSR		
	MOV	pc, lr	     @ retorna da funcao		
--------------------------------------------------
</pre>


<p>
Vamos mostrar passo a passo como compilar/montar e rodar item-2-2.s .
</p>
<ul class="org-ul">
<li>Rode a image do docker. O jeito mais fácil é:</li>
</ul>
<pre class="example">
~/Downloads/gcc-arm$ ./run_docker.sh 
</pre>

<ul class="org-ul">
<li>Compile/monte o código item-2-2.s ; o jeito mais fácil é aproveitar o alias gcc que já existe dentro da imagem:</li>
</ul>
<pre class="example">
student:~/src$ ls
alo  hello  hello.c  hello.s  item-2-2.s
student:~/src$ alias gcc
alias gcc='arm-elf-gcc -Wall -Wextra -g'
student:~/src$ gcc item-2-2.s 
</pre>

<ul class="org-ul">
<li>Ao rodar, o arquivo a.out é gerado como saida:</li>
</ul>
<pre class="example">
student:~/src$ ls -alt |more
total 500
-rwxrwxr-x 1 student student 126239 Apr 16 00:40 a.out
drwxrwxrwx 2 student student   4096 Apr 16 00:40 .
-rw-rw-r-- 1 student student     39 Mar 20 19:38 hello.c
-rwxrwxr-x 1 student student 221628 Mar 20 19:34 alo
-rw-rw-r-- 1 student student    396 Mar 20 19:31 hello.s
-rwxrwxr-x 1 student student 221868 Mar 20 19:25 hello
drwxr-xr-x 1 student student   4096 Mar 20 19:17 ..
-rw-rw-rw- 1 student student    147 Mar 20 19:11 item-2-2.s
</pre>

<ul class="org-ul">
<li>Para entrar no gdb, o jeito mais fácil é usar o alias gdb:</li>
</ul>
<pre class="example">
student:~/src$ alias gdb
alias gdb='arm-elf-gdb -tui --command=/home/student/.gdbinit/default'
student:~/src$ gdb a.out 
</pre>

<ul class="org-ul">
<li>Uma veze dentro do gdb,</li>
</ul>
<p>
Tecle "return" para continue até ver algo como:
</p>
<pre class="example">

   │7               MOV     r0, #0x18                                          │
   │8               LDR     r1, =0x20026                                       │
   └───────────────────────────────────────────────────────────────────────────┘
sim No process In:                                           Line: ??   PC: 0x0 
Loading section .data, size 0x8a8 vma 0xa118
Loading section .eh_frame, size 0x4 vma 0xa9c0
Loading section .ctors, size 0x8 vma 0xa9c4
Loading section .dtors, size 0x8 vma 0xa9cc
Loading section .jcr, size 0x4 vma 0xa9d4
Start address 0x8110
Transfer rate: 27882 bits/sec.
(gdb) 
</pre>

<ul class="org-ul">
<li>vamos nos posicionar para rodar a primeira instrucao; para isso, "break main" seguido de "run" ou de forma mais sucinta "b main" , "r" como vemos abaixo:</li>
</ul>
<pre class="example">
(gdb) b main
Breakpoint 1 at 0x8218: file item-2-2.s, line 4.
(gdb) r
Starting program: /home/student/src/a.out 

Breakpoint 1, main () at item-2-2.s:4
Current language:  auto; currently asm
(gdb) 
</pre>

<ul class="org-ul">
<li>agora voce já pode rodar passo a passo! Experimente usar "step" ou "next" ; de forma mais sucinta "s" ou "n". Veja que os registradores vão se modificando.</li>
<li>Para sair do debug "quit" ou "q".</li>
</ul>

<p>
Veja isso ocorrendo no video: 
</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/P4OacfCPLlc" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>

<div id="outline-container-org78d3dfc" class="outline-4">
<h4 id="org78d3dfc"><span class="section-number-4">1.5.1</span> Uma software interrupt</h4>
<div class="outline-text-4" id="text-1-5-1">
<iframe width="560" height="315" src="https://www.youtube.com/embed/2Nl3Dqiiec8" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


<p>
No código temos:
</p>
<pre class="example">
LDR	r1, =0x20026		
SWI	0x123456		
</pre>
<p>
que se refere a uma software interrupt pedindo um servico do monitor da placa evaluator7t. Como estamos rodando de forma simulada, essa software interrupt irá travar o gdb. Assim, nao rodem o SWI (basta colocar um breakpoint).
Uma pergunta interessante é:
</p>
<ul class="org-ul">
<li>qual a diferenca entre LDR e MOV? Observem que ambas as instrucoes carregaram valores imediatos nos registradores. A diferenca é que com LDR é possível carregar valores quaisquer de 32 bits enquanto que com o MOV não. Isso será importante para a questao 3.10.1</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org9b0252f" class="outline-3">
<h3 id="org9b0252f"><span class="section-number-3">1.6</span> video sobre o processador ARM, OPCIONAL</h3>
<div class="outline-text-3" id="text-1-6">
<p>
Voce ainda nao tem condicoes de entender tudo o que o video explica. Muita coisa ficarah clara no decorrer do curso principalmente depois da aula sobre interrupcoes. Assim, nao gaste tempo com isso.
</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/4VRtujwa_b8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>
</div>


<div id="outline-container-orgd7eef51" class="outline-3">
<h3 id="orgd7eef51"><span class="section-number-3">1.7</span> referência: ARM Laboratory Exercises, cap. 1</h3>
<div class="outline-text-3" id="text-1-7">
<p>
Ler o primeiro capítulo de <a href="#orgd64c93b">16.1</a>. 
Fazer exercícios 1.7
</p>
</div>
</div>


<div id="outline-container-orga33cd1d" class="outline-3">
<h3 id="orga33cd1d"><span class="section-number-3">1.8</span> Entregue o relatorio ateh o final do dia, INDIVIDUALMENTE.</h3>
<div class="outline-text-3" id="text-1-8">
<ul class="org-ul">
<li>O relatorio eh para se fazer em GRUPO. Deve conter as respostas do cap 1 da apostila, 1.7.1 e 1.7.2 ; mas a entrega eh individual, ou seja, dois alunos da mesma equipe acabam entregando o mesmo relatorio.</li>
<li>Cada aluno recebeu a atividade de entrega do relatorio do google classroom; essa entrega eh INDIVIDUAL. Isto eh, o mesmo relatorio do grupo serah entregue várias vezes: uma para cada integrante. Caso o aluno da equipe nao entregue o relatorio, vou entender que ele nao participou do relatorio.</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-orgcc144ec" class="outline-2">
<h2 id="orgcc144ec"><span class="section-number-2">2</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-05-13 qui&gt; </span></span> . E2: Programming Basics (cap2) + Data Processing Operations (cap3).</h2>
<div class="outline-text-2" id="text-2">
<div id="text-table-of-contents">
<ul>
<li><a href="#org66b1c88">2.1. PLANEJAMENTO INDIVIDUAL (3 pontos):</a></li>
<li><a href="#orga23bf85">2.2. OBJETIVO:</a></li>
<li><a href="#org6c66be0">2.3. Fazer todos os exercícios do item 2.4 pagina 2-8 da apostila usando o gnuarm.</a>
<ul>
<li><a href="#orgf3efaf8">2.3.1. Exercicio 2.4.1</a></li>
<li><a href="#org20a1faf">2.3.2. Exercicio 2.4.2</a></li>
<li><a href="#org009b4d1">2.3.3. Exercicio 2.4.3</a></li>
</ul>
</li>
<li><a href="#org7eb8a51">2.4. Estude o capítulo 3 da apostila.</a>
<ul>
<li><a href="#orgc940cb1">2.4.1. pg 3-7:</a></li>
</ul>
</li>
<li><a href="#org28626cd">2.5. Faca os exercicios 3.10.1 a 3.10.4 da pagina 3-11, 3-12. Dicas:</a>
<ul>
<li><a href="#orgd10de64">2.5.1. Desvio condicional</a></li>
<li><a href="#org8cac30e">2.5.2. Exercicio 3.10.1 - Signed and unsigned addition</a></li>
<li><a href="#org9d230d0">2.5.3. Exercicio 3.10.2 - Multiplication / Multiplicacao de numeros</a></li>
<li><a href="#org2224cb8">2.5.4. Exercicio 3.10.3 - Multiplication shortcuts / Multiplicacao pelo numero 32.</a></li>
<li><a href="#orgab630ac">2.5.5. Exercicio 3.10.4 Register-swap algorithm</a></li>
</ul>
</li>
<li><a href="#org1f21eb3">2.6. tarefa E2 - printscreen (INDIVIDUAL)</a></li>
<li><a href="#org382f070">2.7. tarefa E2 - relatorio e codigos fontes</a>
<ul>
<li><a href="#org72994df">2.7.1. códigos fontes de todos os itens (diversos arquivos .s)</a></li>
<li><a href="#org114e5e4">2.7.2. o relatorio feito em grupo (arquivo .pdf).</a></li>
</ul>
</li>
<li><a href="#org4c88637">2.8. Desempenho da classe:</a></li>
</ul>
</div>
<p>
A apostila "ARM Laboratory Exercises" roda código feito para o codewarrior/freescale e não para o gnuarm. Portanto, ADAPTEM o código da apostila para rodar no gnuarm como feito na aula passada, exemplo do item 2-2 da apostila.
</p>
</div>

<div id="outline-container-org66b1c88" class="outline-3">
<h3 id="org66b1c88"><span class="section-number-3">2.1</span> PLANEJAMENTO INDIVIDUAL (3 pontos):</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Antes da aula, leia o cap2 e o cap 3 da apostila.
Rode o código item-2-2.s no seu computador e acompanhe os registradores sendo modificados.
Observe as flags do cspsr (apostila cap 1) ao fazer a soma. As flags são atualizadas? (Resposta: Não).
Agora, no código item-2-2.s troque ADD por ADDS. As flags são atualizadas logo depois da soma (ADD)? 
Retorne essa tarefa com um arquivo pdf contendo dois printscreens da tela de SEU COMPUTADOR do item-2-2.s mostrando os registradores, principalmente o CPSR. quando:
printscreen1) antes de rodar a instrucao ADDS
printscreen2) depois de rodar a instrucao ADDS
O objetivo eh observar como variam as flags do CPSR. Escreva o quanto valem as flags N,C,Z,V e se isso estah compativel com o esperado.
No seu planejamento em pdf explique se as flags variaram como voce esperava que variassem.
</p>
</div>
</div>


<div id="outline-container-orga23bf85" class="outline-3">
<h3 id="orga23bf85"><span class="section-number-3">2.2</span> OBJETIVO:</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>capítulo 2 e parte do 3 da apostila, mas ao invés de usarmos o codewarrior para windows estaremos usando o gnuarm no linux ubuntu.</li>
</ul>
<p>
Facam os seguintes exercicios da apostila e criem um relatorio com as respostas dos exercicios:
</p>
<ul class="org-ul">
<li>cap2: todo o item 2.4: de 2.4.1 a 2.4.3</li>
<li>cap3: Faca de 3.10.1 ateh 3.10.4 ; Veja detalhadamente as intrucoes ARM em <a href="#orgc687d5e">16.11</a></li>
</ul>
</div>
</div>

<div id="outline-container-org6c66be0" class="outline-3">
<h3 id="org6c66be0"><span class="section-number-3">2.3</span> Fazer todos os exercícios do item 2.4 pagina 2-8 da apostila usando o gnuarm.</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Observacao sobre os exercicios
As perguntas do item 2.4 se referem ao codewarrior (ambiente usado pela apostila no lugar do gnuarm); por isso pensem nas questoes referindo-se ao gnuarm.
</p>
</div>
<div id="outline-container-orgf3efaf8" class="outline-4">
<h4 id="orgf3efaf8"><span class="section-number-4">2.3.1</span> Exercicio 2.4.1</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
No ambiente codewarrior existe um make. Durante o nosso curso, nao precisaremos do make uma vez que o proprio arm-elf-gcc dispara o assembler e o linker. Para ver o que foi gerado pelo arm-elf-gcc basta fazer:
</p>
<hr />
<p>
$ ls -alt|more
</p>
<hr />
<p>
Esse comando coloca no topo os arquivos recentemente modificados ou criados.
Apenas relatem o que foi feito - uso do arm-elf-gcc, geracao do arquivo e arm-elf-gdb para rodá-lo.
</p>
</div>
</div>
<div id="outline-container-org20a1faf" class="outline-4">
<h4 id="org20a1faf"><span class="section-number-4">2.3.2</span> Exercicio 2.4.2</h4>
<div class="outline-text-4" id="text-2-3-2">
</div>
<ol class="org-ol">
<li><a id="org79b5e2f"></a>step x next<br />
<div class="outline-text-5" id="text-2-3-2-1">
<p>
A pergunta 2.4.2 pergunta sobre a diferenca entre step e stepin no codewarrior . Para o gdb, a pergunta se refere a:
step: passo a passo entrando na rotina
next: passo a passo mas sem entrar na rotina. 
Existe um problema GRAVE no uso do next. O arm-elf-gdb misteriosamente se perde ao ver um label como:
</p>

<pre class="example">
  mov r0,1
label:
  move r0,2
</pre>
<p>
Ao executar mov r0,1; o debugger nao pula para a instrucao seguinte usando next. Por isso, muito preferencialmente use 'step'.
</p>
</div>
</li>

<li><a id="orgdf2f62c"></a>Problema ao executar SWI<br />
<div class="outline-text-5" id="text-2-3-2-2">
<p>
A instrucao SWI	0x123456 eh uma interrupcao de software que roda no programa monitor que estah na flash da placa Evaluator-7T. Nós estamos simulando a execucao do codigo no gdb (target sim). O simulador nao possui o tratamento para essa interrupcao de software, por isso,  coloque um breakpoint na linha onde estah a instrucao SWI (ex: linha 9) atraves de "b 9" e rode ateh lah. Dado que estamos sem monitor ou sistema operacional, estaremos sempre fazendo dessa forma: colocando um breakpoint no final do programa para observarmos se rodou ateh o final.
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-org009b4d1" class="outline-4">
<h4 id="org009b4d1"><span class="section-number-4">2.3.3</span> Exercicio 2.4.3</h4>
<div class="outline-text-4" id="text-2-3-3">
<p>
Se quisermos ver os registradores na tela do arm-elf-gdb usando C-x 2, teremos dois formatos hexa e decimal. Porém, é possível observar memória e registradores em outros formatos. Veja o manual do gdb - <a href="http://sourceware.org/gdb/download/onlinedocs/gdb/index.html">http://sourceware.org/gdb/download/onlinedocs/gdb/index.html</a>
Exemplos:
</p>
<pre class="example">
p/x $pc
p/x $cpsr
x/i $pc
</pre>
<p>
Usando o help
 help x
 help p
</p>

<p>
Voce deve ter observado que 
x - serve para ver memoria externa. 
</p>
<pre class="example">
x/d $r1
</pre>
<p>
apresenta o conteudo de r1 em hexadecimal e o conteudo apontado por r1 na memoria em decimal.
</p>

<pre class="example">
p/d $r1
</pre>
<p>
apresenta o conteudo de r1 em decimal.
</p>

<p>
Uma forma !!!PERIGOSA!!! de ver os bits do registrador de status eh:
</p>
<pre class="example">
p/t $cpsr
</pre>
<p>
porem, os primeiros zeros serao OMITIDOS e voce pode estar vendo menos que 32 bits. Tome cuidado! Compare o cpsr com o comando "info registers".
A forma segura eh:
</p>
<pre class="example">
p/x $cpsr
</pre>
</div>
</div>
</div>




<div id="outline-container-org7eb8a51" class="outline-3">
<h3 id="org7eb8a51"><span class="section-number-3">2.4</span> Estude o capítulo 3 da apostila.</h3>
<div class="outline-text-3" id="text-2-4">
</div>
<div id="outline-container-orgc940cb1" class="outline-4">
<h4 id="orgc940cb1"><span class="section-number-4">2.4.1</span> pg 3-7:</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
ADD r0, r1, #0xc5, ROR 10
ver desenho na pagina 3-6.
</p>

<p>
1100 0101 para a direita em um registrador de 32 bits
</p>

<p>
depois de rodar 8 vezes temos
</p>

<p>
1100 0101 0000 &#x2026;
e depois de 10 vezes temos:
</p>

<p>
0011 0001 0100 &#x2026; 
</p>

<p>
o que fornece um o resultado da apostila:
</p>

<p>
31 40 00 00
0011 0001 0100 0000 0000  0000 0000 0000
</p>
</div>
</div>
</div>

<div id="outline-container-org28626cd" class="outline-3">
<h3 id="org28626cd"><span class="section-number-3">2.5</span> Faca os exercicios 3.10.1 a 3.10.4 da pagina 3-11, 3-12. Dicas:</h3>
<div class="outline-text-3" id="text-2-5">
</div>
<div id="outline-container-orgd10de64" class="outline-4">
<h4 id="orgd10de64"><span class="section-number-4">2.5.1</span> Desvio condicional</h4>
<div class="outline-text-4" id="text-2-5-1">
<p>
Para fazer os exericios, voce vai precisar de desvio condicional. Veja a tabela na apostila em: 5.2 Execution conditions .
Exemplo de uso:
</p>
<pre class="example">
CMP R0,R1
BGT label
</pre>
<p>
onde GT estah na tabela. Assim, podemos ter varios desvios condicionais como: BEQ, BNE e ateh mesmo BAL, mas como AL eh "default", use simplesmente "B" para o desvio incondicional. Em ARM eh possivel combinar qualquer instrucao com uma condicao. Ex: MOVEQ - move caso EQ.
</p>
</div>
</div>

<div id="outline-container-org8cac30e" class="outline-4">
<h4 id="org8cac30e"><span class="section-number-4">2.5.2</span> Exercicio 3.10.1 - Signed and unsigned addition</h4>
<div class="outline-text-4" id="text-2-5-2">
<p>
Use LDR para carregar valores de 32 bits em registradores.
Ao inves de fazer:
</p>
<pre class="example">
mov r1,#0x12345678
</pre>
<p>
faça:
</p>
<pre class="example">
ldr r1,=0x12345678
</pre>
</div>

<ol class="org-ol">
<li><a id="org6293f35"></a>Cuidado com as flags<br />
<div class="outline-text-5" id="text-2-5-2-1">
<p>
ADD nao atualiza as flags do CPSR;
ADDS atualiza as flags do CPSR.
Igualmente SUB x SUBS, MOV x MOVS, etc.  
</p>
</div>
</li>

<li><a id="orgf7b4426"></a>Carry x overflow<br />
<div class="outline-text-5" id="text-2-5-2-2">
<p>
Se representarmos numeros em 4 bits em complemento de 2, podemos representar desde o -8 ateh o 7. Ao somarmos -1 e 1 temos carry mas nao temos overflow. Somando 5+4, temos que 9&gt;7 e portanto temos o overflow.
</p>
</div>
</li>

<li><a id="org62c4216"></a>signed x unsigned<br />
<div class="outline-text-5" id="text-2-5-2-3">
<p>
Na apostila: Does their meaning change when the data values are unsigned numbers? Numa representacao de 4 bits unsigned, os numeros variam de 0 a 15. Assim, ao somarmos 7+2, obtemos 9 que pode ser representado como unsigned e nao pode ser representado em 4 bits unsigned. Assim, OVERFLOW para unsigned deve ser visto olhando a flag CARRY e a OVERFLOW em si, deixa de ter sentido.
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-org9d230d0" class="outline-4">
<h4 id="org9d230d0"><span class="section-number-4">2.5.3</span> Exercicio 3.10.2 - Multiplication / Multiplicacao de numeros</h4>
<div class="outline-text-4" id="text-2-5-3">
<ul class="org-ul">
<li>no resultado tivemos a flag N setada, embora multiplicamos dois numeros negativos (e o resultado deveria ser positivo). A instrucao MULS (tem 1 L somente, nao confunda com MULLS), multiplica 2 numeros de 32 bits e coloca o resultado em um numero de 32 bits. Isso nao funciona bem. Vamos pensar em numeros de 4 bits variando de -8 a 7 em complemento de 2. Se multiplicarmos -1 e -8 em complemento de 2, temos +8. Porem, 8 nao pode ser representado em complemento de 2, 4 bits. A apostila quer mostrar que as flags foram atualizadas erradas nessa instrucao. Na verdade, nem as flags e nem o conteudo dos registradores eh confiavel dado que nao se consegue sempre multiplicar 2 numeros de 32 bits e colocar o resultado em 32 bits. O certo eh colocar o resultado em um numero de 64 bits. Para entender melhor veja no site da ARM, a especificacao da instrucao MUL: <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0068b/CIHIHGGJ.html">http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0068b/CIHIHGGJ.html</a> . Se quisermos observar o bottom (32 bits menos significativos) em MULS contendo o numero todo, temos que multiplicar numeros que caibam em representacoes de 16 bits.</li>
</ul>
</div>

<ol class="org-ol">
<li><a id="org624dc33"></a>Why is there a need for two separate long multiply instructions, UMULL and SMULL?<br />
<div class="outline-text-5" id="text-2-5-3-1">
<p>
Ambas as instrucoes multiplicam 2 numeros de 32 bits e colocam o resultado de 64 bits em 2 registradores: um mais signficativo e outro menos significativo. O resultado eh diferente se o numero eh signed ou unsigned. Por exemplo: pensando em multiplicar 2 numeros de 4 bits, temos no caso de 1111 = 15(unsgined) ou (-1) signed. 15*15 eh um resultado totalmente diferente de (-1) * (-1). Daih a necessidade de UMULL e SMULL. Observe que se o resultado eh colocado em 2 registradores, como R0(mais signficativo) e R1; entao apenas o bit mais significativo de R0 eh quem diz se &lt;R0,R1&gt; eh positivo ou negativo.
</p>
</div>
</li>


<li><a id="orgb91235f"></a>Pequeno erro:<br />
<div class="outline-text-5" id="text-2-5-3-2">
<p>
Obs: Na apostila ARM Lab Manual temos na pg 3-5
   UMULL r6, r8, r0, r1 ; {r6,r8} = r0 × r1
onde aparentemente r6 eh o mais significativo. Pelo site da ARM temos que o r6 (primeiro argumento) eh o menos significativo.
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-org2224cb8" class="outline-4">
<h4 id="org2224cb8"><span class="section-number-4">2.5.4</span> Exercicio 3.10.3 - Multiplication shortcuts / Multiplicacao pelo numero 32.</h4>
<div class="outline-text-4" id="text-2-5-4">
<ul class="org-ul">
<li>pense em algum shift.</li>
<li>use MOV com deslocamento. Veja: <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0552a/BABHGAJI.html">http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0552a/BABHGAJI.html</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgab630ac" class="outline-4">
<h4 id="orgab630ac"><span class="section-number-4">2.5.5</span> Exercicio 3.10.4 Register-swap algorithm</h4>
<div class="outline-text-4" id="text-2-5-5">
<p>
sem problemas, exercicio simples de ser feito.
</p>
</div>
</div>
</div>


<div id="outline-container-org1f21eb3" class="outline-3">
<h3 id="org1f21eb3"><span class="section-number-3">2.6</span> tarefa E2 - printscreen (INDIVIDUAL)</h3>
<div class="outline-text-3" id="text-2-6">
<p>
Retorne o printscreen da tela de SEU computador (arquivo .png) referente ao exericio
3.10.4, seguindo:
</p>
<hr />
<p>
Write the ARM code to implement the above algorithm, and test it with the values of
A = 0xF631024C and B = 0x17539ABD . Show your instructor the contents before and after the program has run.
</p>
<hr />
<p>
Nao eh necessario anexar a tela do conteudo antes de rodar o programa, apenas depois. A tela deve conter:
</p>
<ul class="org-ul">
<li>seu codigo e</li>
<li>os registradores depois de ter rodado o codigo.</li>
</ul>

<p>
Observacao: vai ter mais pontos quem entregar o printscreen no horario da aula
</p>
</div>
</div>

<div id="outline-container-org382f070" class="outline-3">
<h3 id="org382f070"><span class="section-number-3">2.7</span> tarefa E2 - relatorio e codigos fontes</h3>
<div class="outline-text-3" id="text-2-7">
<p>
Sem zipar nada, entreguem os seguintes arquivos:
</p>
</div>
<div id="outline-container-org72994df" class="outline-4">
<h4 id="org72994df"><span class="section-number-4">2.7.1</span> códigos fontes de todos os itens (diversos arquivos .s)</h4>
<div class="outline-text-4" id="text-2-7-1">
<p>
Coloquem no cabeçalho de cada arquivo: objetivo do fonte - mostrando a qual item o arquivo (.s) se refere e a forma como o código eh gerado e debugado. Coloque comentarios onde devido.
</p>
</div>
</div>

<div id="outline-container-org114e5e4" class="outline-4">
<h4 id="org114e5e4"><span class="section-number-4">2.7.2</span> o relatorio feito em grupo (arquivo .pdf).</h4>
<div class="outline-text-4" id="text-2-7-2">
<p>
Nao me entreguem em .docx porque pode dar problemas ao abrir. Coloquem no relatorio a copia do codigo fonte e as saidas ao rodarem os itens vistos. Isso pode ser em printscreen ou mesmo em texto (fonte Courier para ficar bonito) atraves de copy &amp; paste.
</p>
</div>
</div>
</div>


<div id="outline-container-org4c88637" class="outline-3">
<h3 id="org4c88637"><span class="section-number-3">2.8</span> Desempenho da classe:</h3>
<div class="outline-text-3" id="text-2-8">
<p>
algumas equipes nao conseguiram terminar todos os exercicios.
</p>
</div>
</div>
</div>




<div id="outline-container-orgfc22a99" class="outline-2">
<h2 id="orgfc22a99"><span class="section-number-2">3</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-05-20 qui&gt; </span></span> . E3: Data Processing Operations (cap3).</h2>
<div class="outline-text-2" id="text-3">
<div id="text-table-of-contents">
<ul>
<li><a href="#orge5c5fa1">3.1. PLANEJAMENTO (3 pontos - apresentacao INDIVIDUAL em pdf como retorno de atividade, mas discutam com sua dupla antes da aula.):</a>
<ul>
<li><a href="#orgba3a6bb">3.1.1. A - leiam o capitulo 3 da apostila.</a></li>
<li><a href="#org9fa809c">3.1.2. B - Respondam as seguintes perguntas</a></li>
<li><a href="#org17434c5">3.1.3. C - prepare a solucao de 3.10.7 (individualmente no seu computador)</a></li>
<li><a href="#org4aca5a5">3.1.4. retorne a tarefa no google classroom</a></li>
</ul>
</li>
<li><a href="#org6348a59">3.2. OBJETIVO:</a></li>
<li><a href="#org5e16cd0">3.3. DICAS e Observacoes:</a>
<ul>
<li><a href="#org54180bc">3.3.1. Desvio condicional</a></li>
<li><a href="#orgb8d85a2">3.3.2. Exercicio 3.10.5 - Signed multiplication</a></li>
<li><a href="#orgce882bf">3.3.3. Exercicio 3.10.6 - Absolute value</a></li>
<li><a href="#org81a6ff7">3.3.4. Exercicio 3.10.7 Division</a></li>
<li><a href="#orgfca557d">3.3.5. Exercicio 3.10.8 Gray codes</a></li>
</ul>
</li>
<li><a href="#org61b2b56">3.4. Retorne as seguinte atividades no google classroom:</a>
<ul>
<li><a href="#orgeb185df">3.4.1. 1) Entrega de screenshot (INDIVIDUAL)</a></li>
<li><a href="#org8dc161d">3.4.2. 2) o relatorio em PDF feito em grupo + código fonte de todos os itens da experiencia (excluindo os do planejamento). .</a></li>
</ul>
</li>
<li><a href="#org916d1cf">3.5. Desempenho da classe:</a></li>
</ul>
</div>
</div>
<div id="outline-container-orge5c5fa1" class="outline-3">
<h3 id="orge5c5fa1"><span class="section-number-3">3.1</span> PLANEJAMENTO (3 pontos - apresentacao INDIVIDUAL em pdf como retorno de atividade, mas discutam com sua dupla antes da aula.):</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-orgba3a6bb" class="outline-4">
<h4 id="orgba3a6bb"><span class="section-number-4">3.1.1</span> A - leiam o capitulo 3 da apostila.</h4>
</div>
<div id="outline-container-org9fa809c" class="outline-4">
<h4 id="org9fa809c"><span class="section-number-4">3.1.2</span> B - Respondam as seguintes perguntas</h4>
<div class="outline-text-4" id="text-3-1-2">
</div>
<ol class="org-ol">
<li><a id="org72d1d1e"></a>1. O que há de errado nas seguintes instrucoes:<br />
<div class="outline-text-5" id="text-3-1-2-1">
<pre class="example">
a. ADD r3,r7, #1023
b. SUB r11, r12, r3, LSL #32
</pre>

<p>
Sugestao:
</p>
<ul class="org-ul">
<li>vejam os codigos de maquinas e observem que certos numeros nao servem para fazer o codigo de maquina.</li>
<li>coloquem no gnuarm e vejam o erro.</li>
</ul>
</div>
</li>

<li><a id="orgaa65758"></a>2. Sem usar a instrucao MUL, de as seguintes instrucoes para multiplicar o registrador R4 por:<br />
<div class="outline-text-5" id="text-3-1-2-2">
<pre class="example">
a. 132
b. 255
c. 18
d. 16384
</pre>

<p>
Dicas (apenas para pensar em como resolver os itens a,b,d,e acima):
</p>
<ul class="org-ul">
<li>como vc. faria para multiplicar um valor por 4? Dica: use o MOV com o deslocamento. r1 = 4*r0</li>
<li>como vc. faria para multiplicar um valor por 5? Dica: use ADD com deslocamento - r1 = r0+4*r0</li>
<li>como vc. faria para multiplicar um valor por 3? r1 = r0*4 - r0; veja a diferenca entre SUB e RSB</li>
<li>como vc. faria para multiplicar um numero por 15? Multiplica por 3 e depois por 5.</li>
</ul>
</div>
</li>

<li><a id="orge43208d"></a>3. Escreve uma rotina que compara 2 valores de 64-bits usando somente 2 instrucoes. (dica: a segunda instrucao é condicionalmente executada, baseada no resultado da primeira comparacao).<br />
<div class="outline-text-5" id="text-3-1-2-3">
<p>
No cap. 5 da apostila existe uma tabela com todas as condicoes possiveis. Exemplo de instrucao condicional: ADDEQ R0,R1,R2 = execute a soma se a flag Z no CPSR == 1. Alguns alunos reclamaram ser necessario consultar o cap. 5, mas nao dah para fazer o cap. 3 sem saber instrucoes condicionais (sorry!).
</p>
</div>
</li>
<li><a id="orgf3a5460"></a>4. Escreva uma rotina que desloque um valor de 64-bits (armazenado em 2 registradores r0 e r1) de um bit para a direita.<br />
<div class="outline-text-5" id="text-3-1-2-4">
<p>
o arm-elf-gcc nao estah compilando uma instrucao que lide com RRX como
 mov &#x2026; RRX #1
porem compila outras como
 mov &#x2026; ROR #1
porem, o arm-elf-gcc compila:
 mov &#x2026; RRX 
ou seja, ao usar RRX jah se supoe que desloca de 1 bit para direita rodando com o carry.
</p>
</div>
</li>

<li><a id="org56df03b"></a>5. idem 4, para a esquerda.<br /></li>
</ol>
</div>


<div id="outline-container-org17434c5" class="outline-4">
<h4 id="org17434c5"><span class="section-number-4">3.1.3</span> C - prepare a solucao de 3.10.7 (individualmente no seu computador)</h4>
<div class="outline-text-4" id="text-3-1-3">
<ul class="org-ul">
<li>Rascunhe a solucado do exercicio de divisao 3.10.7; ou seja, como é o algoritmo da divisao. Coloque o algoritmo em codigo ARM (nao eh necessario testar). A operacao de divisao deve ser feita com shift como faz a profa. do primário e nao o algoritmo ineficiente e simples que retira um numero do outro.</li>
</ul>
<p>
Veja: <a href="http://courses.cs.vt.edu/~cs1104/Division/ShiftSubtract/Shift.Subtract.html">http://courses.cs.vt.edu/~cs1104/Division/ShiftSubtract/Shift.Subtract.html</a> e coloque no papel a simulacao de 1101 dividido por 10. Existe algum erro nesse algoritmo de divisao? Teste com diversos casos no proprio site antes da aula (porque existe sim um erro).
</p>
</div>
</div>

<div id="outline-container-org4aca5a5" class="outline-4">
<h4 id="org4aca5a5"><span class="section-number-4">3.1.4</span> retorne a tarefa no google classroom</h4>
<div class="outline-text-4" id="text-3-1-4">
<p>
Enunciado no google classroom: Veja em <a href="http://www2.pcs.usp.br/~jkinoshi/2021/labmicro-21.html">http://www2.pcs.usp.br/~jkinoshi/2021/labmicro-21.html</a> o que deve ser feito como  planejamento da E3 e anexe o pdf como retorno de atividade. Discutam com sua dupla antes da aula.
</p>
</div>
</div>
</div>

<div id="outline-container-org6348a59" class="outline-3">
<h3 id="org6348a59"><span class="section-number-3">3.2</span> OBJETIVO:</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>terminar capítulo 3 da apostila. Fazer os exercicios de 3.10.5 ateh 3.10.8</li>
</ul>
</div>
</div>
<div id="outline-container-org5e16cd0" class="outline-3">
<h3 id="org5e16cd0"><span class="section-number-3">3.3</span> DICAS e Observacoes:</h3>
<div class="outline-text-3" id="text-3-3">
</div>
<div id="outline-container-org54180bc" class="outline-4">
<h4 id="org54180bc"><span class="section-number-4">3.3.1</span> Desvio condicional</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
Para fazer os exericios, voce vai precisar de desvio condicional. Veja a tabela na apostila em: 5.2 Execution conditions .
Exemplo de uso:
</p>
<pre class="example">
CMP R0,R1
BGT label
</pre>
<p>
onde GT estah na tabela. Assim, podemos ter varios desvios condicionais como: BEQ, BNE e ateh mesmo BAL, mas como AL eh "default", use simplesmente "B" para o desvio incondicional. Em ARM eh possivel combinar qualquer instrucao com uma condicao. Ex: MOVEQ - move caso EQ.
</p>
</div>
</div>

<div id="outline-container-orgb8d85a2" class="outline-4">
<h4 id="orgb8d85a2"><span class="section-number-4">3.3.2</span> Exercicio 3.10.5 - Signed multiplication</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
nao percam tempo com a restricao da apostila: usem instrucoes condicionais para facilitar. No cap. 5 da apostila existe uma tabela com todas as condicoes possiveis. De preferencia, facam primeiro o exercicio 3.10.6 . Pequeno erro do UMULL na apostila explicado no item 3.10.2
</p>
</div>
</div>
<div id="outline-container-orgce882bf" class="outline-4">
<h4 id="orgce882bf"><span class="section-number-4">3.3.3</span> Exercicio 3.10.6 - Absolute value</h4>
<div class="outline-text-4" id="text-3-3-3">
<p>
Uma dica para se ter o absoluto de um numero eh fazer (zero - numero) caso o numero seja negativo. 
</p>
</div>
</div>

<div id="outline-container-org81a6ff7" class="outline-4">
<h4 id="org81a6ff7"><span class="section-number-4">3.3.4</span> Exercicio 3.10.7 Division</h4>
<div class="outline-text-4" id="text-3-3-4">
<p>
Teste que deve funcionar:
</p>
<ul class="org-ul">
<li>1234567 por 1234</li>
</ul>

<p>
Teste que talvez falhe:
</p>
<ul class="org-ul">
<li>123456789 por 1234</li>
</ul>

<p>
Teste com
</p>
<ul class="org-ul">
<li>100 / 10</li>
</ul>


<p>
Carregue o numero no registrador com algo como:
</p>

<p>
LRD R0, =123456789
</p>

<p>
Nao precisa de se preocupar caso esteja falhando para codigos onde o bit de sinal do dividendo seja 1.
</p>
</div>
</div>




<div id="outline-container-orgfca557d" class="outline-4">
<h4 id="orgfca557d"><span class="section-number-4">3.3.5</span> Exercicio 3.10.8 Gray codes</h4>
<div class="outline-text-4" id="text-3-3-5">
<ul class="org-ul">
<li>na apostila ARM Lab Manual: A sequencia b010 011 001 000 101 111 110 100 nao eh um codigo de gray de 3 bits (ex: erro ao passar de 000 para 101 alterando dois bits). O codigo pode ser</li>
</ul>
<p>
000 001 011 010 110 111 101 100. Se tiver duvidas em como se forma o codigo gray, consulte o wikipedia.
</p>
</div>
</div>
</div>



<div id="outline-container-org61b2b56" class="outline-3">
<h3 id="org61b2b56"><span class="section-number-3">3.4</span> Retorne as seguinte atividades no google classroom:</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-orgeb185df" class="outline-4">
<h4 id="orgeb185df"><span class="section-number-4">3.4.1</span> 1) Entrega de screenshot (INDIVIDUAL)</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
Formato: png (ou jpg, imagem). Nao me anexe um zip com varias imagens!
Entregue ateh o final da aula o screenshot do exercicio 3.10.7 - sobre a Divisao:
</p>
<hr />
<p>
Write ARM assembly to perform the function of division. Registers r1 and r2 contain
the dividend and divisor, r3 contains the quotient, and r5 contains the remainder. For
this operation, you can either use a single shift-subtract algorithm or another more
complicated one.
</p>
<hr />
<p>
A divisao deve ser feita entre o seu numero USP e 1000 mostrando os registradores R1 (dividendo: seu numero USP), R2 (divisor: 1000), R3 (quociente), R5 (resto). Assim, retorne o screenshot da tela do gdb com os registradores, logo apos a divisao ter sido feita. O gdb deve estar mostrando duas telas: a tela contendo os registradores e a tela contendo o codigo. Retorne a foto (geralmente um arquivo .png) do screenshot.
</p>
</div>
</div>


<div id="outline-container-org8dc161d" class="outline-4">
<h4 id="org8dc161d"><span class="section-number-4">3.4.2</span> 2) o relatorio em PDF feito em grupo + código fonte de todos os itens da experiencia (excluindo os do planejamento). .</h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
Nao me entreguem em .docx porque pode dar problemas ao abrir. Coloquem no relatorio as saidas ao rodarem os itens vistos. Isso pode ser em printscreen ou mesmo em texto (atraves de copy &amp; paste, fonte Courier para ficar bonito) da saida do gdb .
</p>

<p>
Não se esqueçam de colocar no cabeçalho a forma como o código eh gerado e debugado.  NAO COLOQUE OS ARQUIVOS DE CODIGO ZIPADOS. (1 ponto a menos se o fizer). 
</p>
</div>
</div>
</div>


<div id="outline-container-org916d1cf" class="outline-3">
<h3 id="org916d1cf"><span class="section-number-3">3.5</span> Desempenho da classe:</h3>
<div class="outline-text-3" id="text-3-5">
<p>
metade das equipes nao conseguiu implementar o 3.10.8 (mas vale a pena implementar?). O 3.10.8 poderia ser visto como um exercicio extra ou ainda eliminado.
</p>
</div>
</div>
</div>


<div id="outline-container-org57f81a7" class="outline-2">
<h2 id="org57f81a7"><span class="section-number-2">4</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-05-27 qui&gt; </span></span> . E4: Loads and Stores (cap4)</h2>
<div class="outline-text-2" id="text-4">
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc0479a6">4.1. PLANEJAMENTO: (3 pontos) apresentacao individual</a>
<ul>
<li><a href="#org15647e6">4.1.1. A Leia o capitulo 4.</a></li>
<li><a href="#org0c25c91">4.1.2. B Respondam as questoes para apresentar ao professor no comeco da aula:</a></li>
<li><a href="#orgc039859">4.1.3. C - escreva codigo</a></li>
</ul>
</li>
<li><a href="#orgc6fab96">4.2. OBJETIVO:</a></li>
<li><a href="#orgb8e78d9">4.3. Observacoes</a>
<ul>
<li><a href="#orgdbca1e1">4.3.1. Na apostila tem um erro no item:</a></li>
<li><a href="#org85741a0">4.3.2. Exercicio 4.5.1 Assignments with operands in memory</a></li>
<li><a href="#orgac9b27b">4.3.3. Exercicio 4.5.2 Loads and stores</a></li>
<li><a href="#orgf485d3b">4.3.4. Exercicio 4.5.4 Array assignment</a></li>
<li><a href="#orgbb2ec16">4.3.5. Exercicio 4.5.5 Arrays and pointers, 4.5.6 The nth Fibonacci number - sao muito parecidos.</a></li>
</ul>
</li>
<li><a href="#org55fbd5d">4.4. Retorne as tarefas</a>
<ul>
<li><a href="#org5ddd79f">4.4.1. planejamento da exp (jah entregue no dia anterior, em pdf, com os codigos do planejamento inclusos)</a></li>
<li><a href="#org8de6a8f">4.4.2. Entrega do printscreen (INDIVIDUAL)</a></li>
<li><a href="#orgeb43737">4.4.3. codigos fontes + o relatorio em PDF feito em grupo.</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgc0479a6" class="outline-3">
<h3 id="orgc0479a6"><span class="section-number-3">4.1</span> PLANEJAMENTO: (3 pontos) apresentacao individual</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Responda os itens abaixo e retorne a foto do que voce fez ateh no dia anterior aa aula.
</p>
</div>

<div id="outline-container-org15647e6" class="outline-4">
<h4 id="org15647e6"><span class="section-number-4">4.1.1</span> A Leia o capitulo 4.</h4>
</div>
<div id="outline-container-org0c25c91" class="outline-4">
<h4 id="org0c25c91"><span class="section-number-4">4.1.2</span> B Respondam as questoes para apresentar ao professor no comeco da aula:</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
B.1) Descreva o conteúdo do registrador R13 ou sp depois que as seguintes instruções forem executadas, assumindo que a memória contenha os valores mostrados abaixo. O registrador R0 contém 0x24, e o sistema de memória é little-endian (o menos significativo é colocado no endereco mais baixo).
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">Endereço</td>
<td class="org-right">Conteúdo</td>
</tr>

<tr>
<td class="org-right">0x24</td>
<td class="org-right">0x06</td>
</tr>

<tr>
<td class="org-right">0x25</td>
<td class="org-right">0xFC</td>
</tr>

<tr>
<td class="org-right">0x26</td>
<td class="org-right">0x03</td>
</tr>

<tr>
<td class="org-right">0x27</td>
<td class="org-right">0xFF</td>
</tr>
</tbody>
</table>

<pre class="example">
LDRSB sp, [r0]
LDRSH sp, [r0]
LDR sp,[r0]
LDRB sp,[r0]
</pre>

<p>
B.2) Indique se as seguintes instruções usam o modo pré ou pós indexado de endereçamento:
</p>
<pre class="example">
STR r6, [r4,#4]
LDR r3, [r12], #6
LDRB r4, [r3,r2]!
LDRSH r12, [r6]
</pre>


<p>
B.3) Calcule o endereço efetivo das seguintes instruções se o registrador r3 = 0x4000 e o registrador r4 = 0x20
</p>
<pre class="example">
STRB r9, [r3,r4]
LDRB r8,[r3,r4,LSL #3]
LDR r7, [r3], r4
STRB r6, [r3], r4, ASR #2
</pre>


<p>
    B.4)  O que há de errado na seguinte instrução?
Veja "incorrect example" em:
<a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0068b/Chdbifed.html">http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0068b/Chdbifed.html</a>
</p>
<pre class="example">
LDRSB r1,[r6],r3,LSL #4
</pre>
</div>
</div>


<div id="outline-container-orgc039859" class="outline-4">
<h4 id="orgc039859"><span class="section-number-4">4.1.3</span> C - escreva codigo</h4>
<div class="outline-text-4" id="text-4-1-3">
<p>
Escreva o código em Assembly que faça:
</p>
<pre class="example">
for (i=0; i&lt;8; i++) {
  a[i] = b[7-i];
}
</pre>
<p>
instalar o gnuarm na maquina de voces e testar.
Procurem usar as seguintes instrucoes em seu código:
</p>

<ul class="org-ul">
<li>LDR ou ADR (isto é: declarem os dados na memória e leiam de lá; por exemplo, onde comeca o a array b e a array a).</li>
<li>BGE (usem instrucoes que facam o desvio condicional, nao necessariamente BGE).</li>
<li>RSB (para o 7-i)</li>
<li>STR (isto é: armazene de fato o dado na memória).</li>
</ul>

<p>
Vejam: <a href="https://stackoverflow.com/questions/42503417/arm-assembly-arrays/53391341#53391">https://stackoverflow.com/questions/42503417/arm-assembly-arrays/53391341#53391</a> ou informacoes aqui na aula de hoje sobre como alocar uma array na memoria.
</p>
</div>
</div>
</div>

<div id="outline-container-orgc6fab96" class="outline-3">
<h3 id="orgc6fab96"><span class="section-number-3">4.2</span> OBJETIVO:</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Fazer os exercicios do capitulo 4.
</p>
</div>
</div>

<div id="outline-container-orgb8e78d9" class="outline-3">
<h3 id="orgb8e78d9"><span class="section-number-3">4.3</span> Observacoes</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-orgdbca1e1" class="outline-4">
<h4 id="orgdbca1e1"><span class="section-number-4">4.3.1</span> Na apostila tem um erro no item:</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
4.3.1 Direct loading with MOV and MVN
</p>
<pre class="example">
MOV r0, #0x1, 30 ; r0 = 1020         32 - 30 = 2; 2 ** 2 = 4 portanto pula de 4 em 4.
MOV r0, #0xFF, 28 ; r0 = 4080        32 - 28 = 4; 2 ** 4 = 16 portanto pula de 16 em 16.
MOV r0, #0x1, 26	 ; r0 = 4096   32 - 26 = 6; 2 ** 6 = 64 portanto pula de 64 em 64.
</pre>
<p>
mas na realidade eh:
</p>
<pre class="example">
│0x8218 &lt;main&gt;           mov    r0, #4           1 *4 = 4                                 │
│0x821c &lt;main+4&gt;         mov    r0, #4080        255 * 16 = 4080                          │
│0x8220 &lt;main+8&gt;         mov    r0, #64 ; 0x40   1 * 64 = 64.           
</pre>
</div>
</div>

<div id="outline-container-org85741a0" class="outline-4">
<h4 id="org85741a0"><span class="section-number-4">4.3.2</span> Exercicio 4.5.1 Assignments with operands in memory</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
Assignments with operands in memory
Assume an array of 25 words. A compiler associates variables x and y with registers r0
and r1, respectively. Assume that the base address for the array is located in r2.
Translate this C statement/assignment using the post-indexed form:
</p>

<pre class="example">
x = array[5] + y
</pre>
<p>
Now try writing it using the pre-indexed form.
Apenas crie um programa em assembly que use o LDR de forma pre indexada e pos indexada. Force para que os valores nos registradores caiam na posicao array + 5*4 (array de 4 bytes para cada elemento) em ambos os caso.
</p>

<p>
Uma forma simples de se declarar dados, por exemplo, uma array, estah em <a href="http://www.coranac.com/tonc/text/asm.htm">http://www.coranac.com/tonc/text/asm.htm</a> :
</p>

<pre class="example">
    mov     r2, #1
@ Byte loads
    adr     r0, bytes
    ldrb    r3, bytes       @ r3= bytes[0];     // r3= 0x000000FF= 255
    ldrsb   r3, bytes       @ r3= (s8)bytes[0]; // r3= 0xFFFFFFFF= -1
    ldrb    r3, [r0], r2    @ r3= *r0_b++;      // r3= 255, r0++;
@ Halfword loads
    adr     r0, hwords
    ldrh    r3, hwords+2    @ r3= words[1];     // r3= 0x0000FFFF= 65535
    ldrsh   r3, [r0, #2]    @ r3= (s16)r0_h[1]; // r3= 0xFFFFFFFF= -1
    ldrh    r3, [r0, r2, lsl #1]    @ r3= r0_h[1]? No! Illegal instruction :(

@ Byte array: u8 bytes[3]= { 0xFF, 1, 2 };
bytes:
    .byte   0xFF, 1, 2
@ Halfword array u16 hwords[3]= { 0xF001, 0xFFFF, 0xF112 };
    .align  1    @ align to even bytes REQUIRED!!!
hwords:
    .hword  0xF110, 0xFFFF, 0xF112
</pre>

<p>
Para observar os dados na memória dentro do gdb, voce pode fazer
</p>
<pre class="example">
x/20 0x100
</pre>
<p>
para ver 20 words a partir de 0x100
</p>
<pre class="example">
x/21h hwords // hwords eh o label no codigo acima
</pre>
<p>
para ver 21 half words a partir do label hwords.
</p>
<pre class="example">
x/20db array // hwords eh o label no codigo acima
</pre>
<p>
para ver 20 bytes em formato decimal a partir do label array
</p>


<p>
Terminando este item pule para o 4.5.2, lembrando que mais referencias estao em:
<a href="http://www.coranac.com/tonc/text/asm.htm">http://www.coranac.com/tonc/text/asm.htm</a> : pagina mostrando diversos codigos e dados para o gnu assembler
</p>

<p>
<a href="http://www.microcross.com/gnu-arm7t-microcross.pdf">http://www.microcross.com/gnu-arm7t-microcross.pdf</a>
<a href="http://bel.gsi.de/scripts/gnu-arm-assy-quick-ref.pdf">http://bel.gsi.de/scripts/gnu-arm-assy-quick-ref.pdf</a> 
</p>

<p>
e os manuais do GNU estão (por exemplo) em:
<a href="https://sourcery.mentor.com/sgpp/lite/arm/portal/release830">https://sourcery.mentor.com/sgpp/lite/arm/portal/release830</a>
</p>
</div>
</div>

<div id="outline-container-orgac9b27b" class="outline-4">
<h4 id="orgac9b27b"><span class="section-number-4">4.3.3</span> Exercicio 4.5.2 Loads and stores</h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
Translate this C statement/assignment using the
post-indexed form:
</p>
<pre class="example">
array[10] = array[5] + y
</pre>

<p>
Now try it using the pre-indexed form.
</p>

<p>
Pergunta: qual o significado de se ter pre-indexado ou pos-indexado nesse caso?
Resposta: o objetivo é apenas didático. Não tem significado. O uso do pre-indexado ou pos-indexado faz sentido dentro de um loop.
</p>
</div>
</div>

<div id="outline-container-orgf485d3b" class="outline-4">
<h4 id="orgf485d3b"><span class="section-number-4">4.3.4</span> Exercicio 4.5.4 Array assignment</h4>
<div class="outline-text-4" id="text-4-3-4">
<p>
Declare os elementos na memoria usando .byte e use o label ao inves de posicoes fixas como 0x4000, 0x4001, etc.
</p>

<p>
Suponha que ao inves de
b) init<sub>Pointers</sub> (int *a,
esteja escrito
b) init<sub>Pointers</sub> (int *array,
</p>
</div>
</div>

<div id="outline-container-orgbb2ec16" class="outline-4">
<h4 id="orgbb2ec16"><span class="section-number-4">4.3.5</span> Exercicio 4.5.5 Arrays and pointers, 4.5.6 The nth Fibonacci number - sao muito parecidos.</h4>
<div class="outline-text-4" id="text-4-3-5">
<p>
A diferenca eh que 4.5.6 nao pede para calcular a sequencia na memoria, podendo simplesmente usar registradores para isso. Nao existe de fato muita diferenca. Alguns alunos questionaram se 4.5.6 deveria calcula f(n) para qualquer n inteiro. O primeiro problema eh que o resultado deveria caber na memória do computador e portanto n sempre terah que ser limitado: nao eh isso que vamos fazer. Assuma n limitado para resultados cabendo em byte (4.5.5) ou word (4.5.6).
</p>
</div>
</div>
</div>


<div id="outline-container-org55fbd5d" class="outline-3">
<h3 id="org55fbd5d"><span class="section-number-3">4.4</span> Retorne as tarefas</h3>
<div class="outline-text-3" id="text-4-4">
</div>
<div id="outline-container-org5ddd79f" class="outline-4">
<h4 id="org5ddd79f"><span class="section-number-4">4.4.1</span> planejamento da exp (jah entregue no dia anterior, em pdf, com os codigos do planejamento inclusos)</h4>
<div class="outline-text-4" id="text-4-4-1">
<p>
O planejamento jah foi visto no comeco da aula. Se por ventura, voce nao apresentou o planejamento ao professor (porque faltou na aula, o prof. chamou varias vezes e vc. nao respondeu, etc.), sua nota jah estah zerada. Assim, nao precisa entregar o planejamento.
</p>
</div>
</div>


<div id="outline-container-org8de6a8f" class="outline-4">
<h4 id="org8de6a8f"><span class="section-number-4">4.4.2</span> Entrega do printscreen (INDIVIDUAL)</h4>
<div class="outline-text-4" id="text-4-4-2">
<p>
Formato: png (ou jpg, imagem). Nao me anexe um zip com varias imagens!
Entregue ateh o final da aula o screenshot do exercicio:
</p>

<hr />
<p>
4.5.5 The Fibonacci sequence
</p>
<hr />

<p>
com a serie de Fibonacci na memoria com o numero de termos correspondente ao ultimo digito de seu numero USP. NAO COLOQUEM OS DADOS NA POSICAO 0x4000 COMO NA APOSTILA. Tenha o cuidado de declarar os dados na memória como explicado no comentario do item: "Exercicio 4.5.1 Assignments with operands in memory".
</p>
</div>
</div>



<div id="outline-container-orgeb43737" class="outline-4">
<h4 id="orgeb43737"><span class="section-number-4">4.4.3</span> codigos fontes + o relatorio em PDF feito em grupo.</h4>
<div class="outline-text-4" id="text-4-4-3">
</div>
<ol class="org-ol">
<li><a id="org41c4411"></a>código fonte de todos os itens da experiencia (excluindo os do planejamento).<br />
<div class="outline-text-5" id="text-4-4-3-1">
<p>
Não se esqueçam de colocar no cabeçalho a forma como o código eh gerado e debugado.  NAO COLOQUE OS ARQUIVOS DE CODIGO ZIPADOS. (1 ponto a menos se o fizer). 
</p>
</div>
</li>

<li><a id="org7b1f224"></a>relatorio<br />
<div class="outline-text-5" id="text-4-4-3-2">
<p>
Entreguem em pdf, nao me entreguem em .docx porque pode dar problemas ao abrir. Coloquem no relatorio as saidas ao rodarem os itens vistos. Isso pode ser em printscreen ou mesmo em texto (fonte Courier para ficar bonito) atraves de copy &amp; paste.
</p>
</div>
</li>
</ol>
</div>
</div>
</div>


<div id="outline-container-org7bc650b" class="outline-2">
<h2 id="org7bc650b"><span class="section-number-2">5</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-06-10 qui&gt; </span></span> . E5: Conditional Executiong Loops (cap5).</h2>
<div class="outline-text-2" id="text-5">
<div id="text-table-of-contents">
<ul>
<li><a href="#org12f0e07">5.1. PLANEJAMENTO (3 pontos)- individual</a>
<ul>
<li><a href="#org5164edd">5.1.1. A. Leia o Capitulo 5</a></li>
<li><a href="#org08deed5">5.1.2. B. Responda:</a></li>
<li><a href="#org1627943">5.1.3. C. IMPORTANTE: Implemente, teste, apresentando  o printscreen, o codigo de 5.5.4.1</a></li>
</ul>
</li>
<li><a href="#org60e6dd0">5.2. Objetivo</a></li>
<li><a href="#org2e8bf11">5.3. Observacoes</a>
<ul>
<li><a href="#org19988e9">5.3.1. Exercicio 5.5.2</a></li>
<li><a href="#orgae42a1a">5.3.2. Exercicio 5.5.3</a></li>
<li><a href="#org71bc144">5.3.3. Exercicio 5.5.4</a></li>
</ul>
</li>
<li><a href="#org90219cd">5.4. Envie respondendo aas tarefas do google classroom.</a>
<ul>
<li><a href="#orgda70b06">5.4.1. Entrega dos arquivos fontes (feito em grupo, entrega individual) + relatorio.</a></li>
<li><a href="#orgb4749cc">5.4.2. Entrega de screenshot (INDIVIDUAL)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org12f0e07" class="outline-3">
<h3 id="org12f0e07"><span class="section-number-3">5.1</span> PLANEJAMENTO (3 pontos)- individual</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-org5164edd" class="outline-4">
<h4 id="org5164edd"><span class="section-number-4">5.1.1</span> A. Leia o Capitulo 5</h4>
</div>
<div id="outline-container-org08deed5" class="outline-4">
<h4 id="org08deed5"><span class="section-number-4">5.1.2</span> B. Responda:</h4>
<div class="outline-text-4" id="text-5-1-2">
</div>
<ol class="org-ol">
<li><a id="org050fe15"></a>1. Traduza as seguintes instrucoes em uma unica instrucao ARM:<br />
<ol class="org-ol">
<li><a id="org981689f"></a>a. adicione resgistradores r3 e r6 somente se N = 0 (N estah "clear"). Armazene o resultado no registrador r7.<br /></li>
<li><a id="org9c19606"></a>b. adicione resgistradores r3 e r6 somente se N = 1. Armazene o resultado no registrador r7.<br /></li>
<li><a id="org67f61c4"></a>c. Multiplique os registradores r7 e r12, colocando os resulados no registrador r3 somente se C estah setado (C = 1) e Z = 0 .<br /></li>
<li><a id="org6e173c1"></a>d. Multiplique os registradores r7 e r12, colocando os resulados no registrador r3 somente se C clear ou Z set .<br /></li>
<li><a id="org063776b"></a>e. Compare os registradores r6 e r8 somente se Z estah zerado.<br /></li>
<li><a id="orgc22e710"></a>f. Compare os registradores r6 e r8 somente se Z set ou N ≠ V<br />
<div class="outline-text-6" id="text-5-1-2-1-6">
<ol class="org-ol">
<li>Observe a seguinte funcao em C:</li>
</ol>
<pre class="example">
int foo(int x, int y) {
   if ((x + y) &gt;= 0)
         return 0;
   else
         return 1;
}
</pre>

<p>
Suponha que ela tenha sido compilada e traduzida no seguinte codigo:
</p>
<pre class="example">
foo        ADDS r0,r0,r1
             BPL PosOrZ
done      MOV r0, #0
             MOV pc, lr
PosOrZ  MOV r0,#1
             B done
</pre>

<p>
O compilador gerou o código corretamente? O compilador retorna 0 ou 1 em r0. Se não está bom o código, corrija.
Altere o código para que ele execute a funcao em somente 4 instrucoes (dica: use execucao condicional).
</p>
</div>
</li>
</ol>
</li>
</ol>
</div>

<div id="outline-container-org1627943" class="outline-4">
<h4 id="org1627943"><span class="section-number-4">5.1.3</span> C. IMPORTANTE: Implemente, teste, apresentando  o printscreen, o codigo de 5.5.4.1</h4>
<div class="outline-text-4" id="text-5-1-3">
<p>
5.5.4
Finite state machines: a nonresetting sequence recognizer
</p>
</div>
<ol class="org-ol">
<li><a id="org8878788"></a>Exercicio 5.5.4 1. Consider an FSM with one input X and one output Z. The FSM asserts its output Z when it recognizes an input bit sequence of b1011. The machine keeps checking for the sequence and does not reset when it recognizes the sequence. Here is an example input string X and its output Z:<br />
<div class="outline-text-5" id="text-5-1-3-1">
<pre class="example">
X = ...0010110110...
Z = ...0000010010...
</pre>
<p>
Write ARM assembly to implement the sequence recognizer. Start with the initial
input X in r1. Finish with the output Z in r2 at the end of the program.
</p>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-org60e6dd0" class="outline-3">
<h3 id="org60e6dd0"><span class="section-number-3">5.2</span> Objetivo</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Fazer os exercicios do capitulo 5 da apostila em 5.5
</p>
</div>
</div>

<div id="outline-container-org2e8bf11" class="outline-3">
<h3 id="org2e8bf11"><span class="section-number-3">5.3</span> Observacoes</h3>
<div class="outline-text-3" id="text-5-3">
</div>
<div id="outline-container-org19988e9" class="outline-4">
<h4 id="org19988e9"><span class="section-number-4">5.3.1</span> Exercicio 5.5.2</h4>
<div class="outline-text-4" id="text-5-3-1">
<p>
Se vc. considerar que nao eh necessario usar MOVNE, delete essa instrucao do codigo sugerido.  
(mas talvez precise sim - um registrador nao pode ser origem e destino na multiplicacao). 
</p>
</div>
</div>


<div id="outline-container-orgae42a1a" class="outline-4">
<h4 id="orgae42a1a"><span class="section-number-4">5.3.2</span> Exercicio 5.5.3</h4>
<div class="outline-text-4" id="text-5-3-2">
</div>
<ol class="org-ol">
<li><a id="orgc015e13"></a>Find maximum value<br />
<div class="outline-text-5" id="text-5-3-2-1">
<p>
In this exercise, you are to find the largest integer in a series of 32-bit unsigned integers.
The length of the series is determined by the value in register r5. The maximum value
is stored in the memory location 0x5000 at the end of the routine. The data values begin
at memory location 0x5006. Choose 11 or more integers to use. Use as much conditional
execution as possible when writing the code. Demonstrate the program to your lab
instructor and print out the memory space starting at 0x5000 before and after the program
runs. Be sure to include enough memory space to show all of your 32-bit integer values.
</p>

<p>
0x5006 não é múltiplo de 4 - as words devem estar alinhadas em múltiplos de 4. Apenas declare as words (valor maximo e sequencia de words) em seu codigo e deixe que o gnuarm escolha suas posicoes.
</p>
</div>

<ol class="org-ol">
<li><a id="org1c353fb"></a>Obs: A apostila foi escrita para o codewarrior e estamos usando o gnuarm e nesse ambiente é razoavelmente simples definir toda uma área de dados em uma certa posição de memória (no ldscript), mas não é simples definir que dados sejam alocados em um endereço específico - para isso podemos usar ponteiros para a posição fixa.<br />
<div class="outline-text-6" id="text-5-3-2-1-1">
<p>
Nesse laboratório, ao invés de usar 0x5000, defina uma área de dados de 100 bytes assim:
</p>

<pre class="example">
dados: .space 100
</pre>

<p>
e no programa podemos fazer, por exemplo:
</p>
<pre class="example">
LDR r0,=dados+4
</pre>

<p>
e dessa forma não dependemos da posição fixa 0x5000
Caso queira dados jah pre-inicializados faca:
</p>

<pre class="example">
dados: .word 0x1, 0x2 ...
</pre>
</div>
</li>
</ol>
</li>
</ol>
</div>


<div id="outline-container-org71bc144" class="outline-4">
<h4 id="org71bc144"><span class="section-number-4">5.3.3</span> Exercicio 5.5.4</h4>
<div class="outline-text-4" id="text-5-3-3">
<p>
se quiser, declare um numero binario como:
0b10101 dentro do codigo.
</p>
</div>
</div>
</div>




<div id="outline-container-org90219cd" class="outline-3">
<h3 id="org90219cd"><span class="section-number-3">5.4</span> Envie respondendo aas tarefas do google classroom.</h3>
<div class="outline-text-3" id="text-5-4">
</div>
<div id="outline-container-orgda70b06" class="outline-4">
<h4 id="orgda70b06"><span class="section-number-4">5.4.1</span> Entrega dos arquivos fontes (feito em grupo, entrega individual) + relatorio.</h4>
<div class="outline-text-4" id="text-5-4-1">
<ul class="org-ul">
<li>Entregue no dia da aula os codigos fontes de cada exercicio anexando o arquivo um a um. NAO ZIPEM. No cabecalho de cada codigo, escreva como o arquivo deve ser gerado. Comente o codigo para voce mesmo entender na hora da prova. Caso tenha feito algum script para geracao do codigo (recomendado), anexe o script em seu codigo. Embora o codigo seja feito em grupo, a entrega eh INDIVDUAL.</li>

<li>Relatorio em Formato: pdf. Entregue o relatorio (pdf) cada exercicio por seu grupo, com o codigo e screenshot da tela do gdb. Embora o relatorio seja feito em grupo, a entrega eh INDIVDUAL.</li>
</ul>
</div>
</div>

<div id="outline-container-orgb4749cc" class="outline-4">
<h4 id="orgb4749cc"><span class="section-number-4">5.4.2</span> Entrega de screenshot (INDIVIDUAL)</h4>
<div class="outline-text-4" id="text-5-4-2">
<p>
Apresente o printscreen de 5.5.4 item 2 com 
X (R1) = 0x5555AAAA
Y (R8) = 5 (padrao em binario = 0b101)
nbits do padrao (R9) = 3
Apresente em seu printscreen as posicoes onde o padrao foi encontrado Z (R2).
</p>
</div>
</div>
</div>
</div>



<div id="outline-container-org4a2ea09" class="outline-2">
<h2 id="org4a2ea09"><span class="section-number-2">6</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-06-17 qui&gt; </span></span> . E6: Subroutines (cap6)</h2>
<div class="outline-text-2" id="text-6">
<div id="text-table-of-contents">
<ul>
<li><a href="#org4871666">6.1. PLANEJAMENTO (individual)</a>
<ul>
<li><a href="#org8747bc3">6.1.1. A. Ler cap 6.</a></li>
<li><a href="#orgedeb63b">6.1.2. B. Responda</a></li>
<li><a href="#org95003f9">6.1.3. C. IMPORTANTE</a></li>
</ul>
</li>
<li><a href="#org69cdf64">6.2. OBJETIVO</a></li>
<li><a href="#orgece4367">6.3. Observacoes</a>
<ul>
<li><a href="#org6aaa0ea">6.3.1. Ex 6.5.1</a></li>
<li><a href="#org4825440">6.3.2. Ex 6.5.2</a></li>
<li><a href="#orgd2c619b">6.3.3. Ex 6.5.3</a></li>
<li><a href="#orgb8460e7">6.3.4. Ex 6.5.4</a></li>
</ul>
</li>
<li><a href="#orged6fd36">6.4. Envie respondendo aas tarefas do google classroom.</a>
<ul>
<li><a href="#orgc355710">6.4.1. Entrega dos arquivos fontes (feito em grupo, entrega individual) + relatorio.</a></li>
<li><a href="#org0222348">6.4.2. Entrega da saida do gdb (INDIVIDUAL)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org4871666" class="outline-3">
<h3 id="org4871666"><span class="section-number-3">6.1</span> PLANEJAMENTO (individual)</h3>
<div class="outline-text-3" id="text-6-1">
</div>
<div id="outline-container-org8747bc3" class="outline-4">
<h4 id="org8747bc3"><span class="section-number-4">6.1.1</span> A. Ler cap 6.</h4>
</div>
<div id="outline-container-orgedeb63b" class="outline-4">
<h4 id="orgedeb63b"><span class="section-number-4">6.1.2</span> B. Responda</h4>
<div class="outline-text-4" id="text-6-1-2">
<p>
1 O que há de errado com as seguintes instruções:
</p>
<pre class="example">
a) STMIA r5!, {r5, r4, r9}
b) LDMDA r2, {}
    STMDB r15!, [r0-r3, r4, lr}
</pre>

<p>
2 Se o registrador r6 possui 0x8000 (como ponteiro para a memória); após executar
</p>
<pre class="example">
LDMIA r6,{r7,r4,r0,lr}
</pre>

<p>
o que fica em r0, r4, r7 e em lr?
</p>

<p>
3 Assuma que a memória e registradores estejam:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">0x8010</td>
<td class="org-right">0x1</td>
</tr>

<tr>
<td class="org-right">0x800C</td>
<td class="org-right">0xfeeddeaf</td>
</tr>

<tr>
<td class="org-right">0x8008</td>
<td class="org-right">0x00008888</td>
</tr>

<tr>
<td class="org-right">0x8004</td>
<td class="org-right">0x12340000</td>
</tr>

<tr>
<td class="org-right">0x8000</td>
<td class="org-right">0xbabe0000</td>
</tr>
</tbody>
</table>

<p>
r0=0x13; r10xffffffff; r2 = 0xeeeeeeee; r3 0x8000
</p>

<p>
Descreva a memória e conteúdos dos registradores após a instrução:
</p>

<pre class="example">
LDMIA r3!, {r0,r1,r2}
</pre>

<p>
4 Suponha que a pilha esteja como o diagrama abaixo. Que instrução seria necessária para sair do estado original e ir para o estado a), depois b) e depois c)?
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">Endereço</td>
<td class="org-right">Original</td>
<td class="org-right">A</td>
<td class="org-right">B</td>
<td class="org-right">C</td>
</tr>

<tr>
<td class="org-right">0x8010</td>
<td class="org-right">0x1</td>
<td class="org-right">0x1</td>
<td class="org-right">0x1</td>
<td class="org-right">0x1</td>
</tr>

<tr>
<td class="org-right">0x800C</td>
<td class="org-right">0xfeeddeaf</td>
<td class="org-right">0xfeeddeaf</td>
<td class="org-right">0xfeeddeaf</td>
<td class="org-right">0xfeeddeaf</td>
</tr>

<tr>
<td class="org-right">0x8008</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">0xbabe2222</td>
<td class="org-right">0xbabe22222</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-right">0x8004</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">0x12340000</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-right">0x8000</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org95003f9" class="outline-4">
<h4 id="org95003f9"><span class="section-number-4">6.1.3</span> C. IMPORTANTE</h4>
<div class="outline-text-4" id="text-6-1-3">
<p>
Apresente o codigo assembly rodando com printscreen de:
6.5.2 Bubble sorting
mostrando os dados em ordem crescente atraves de um comando como:
x/10d dados
</p>
</div>
</div>
</div>

<div id="outline-container-org69cdf64" class="outline-3">
<h3 id="org69cdf64"><span class="section-number-3">6.2</span> OBJETIVO</h3>
<div class="outline-text-3" id="text-6-2">
<p>
Exercicios 6.5 do 6.5.1 ateh 6.5.4.
</p>
</div>
</div>

<div id="outline-container-orgece4367" class="outline-3">
<h3 id="orgece4367"><span class="section-number-3">6.3</span> Observacoes</h3>
<div class="outline-text-3" id="text-6-3">
</div>
<div id="outline-container-org6aaa0ea" class="outline-4">
<h4 id="org6aaa0ea"><span class="section-number-4">6.3.1</span> Ex 6.5.1</h4>
<div class="outline-text-4" id="text-6-3-1">
<p>
transmit the arguments by way of the stack with two subroutines, func1 and
func2, that demonstrate stack functionality.
É importante que o endereco de retorno seja colocado na pilha em func1.
Declare os elementos na memoria usando .word (veja acima) e use o label ao inves de posicoes fixas como 0x4000, 0x4001, etc.
</p>
</div>
</div>

<div id="outline-container-org4825440" class="outline-4">
<h4 id="org4825440"><span class="section-number-4">6.3.2</span> Ex 6.5.2</h4>
<div class="outline-text-4" id="text-6-3-2">
<p>
Bubble Sort
6.5.2.1. Usem load e store multiplo envolvendo 2 posicoes consecutivas de memoria quando fizerem a "bolha" andar. Embora no exercicio da apostila esteja como byte, usar word porque LDM&#x2026; usa word.
</p>
</div>


<ol class="org-ol">
<li><a id="org8296fc8"></a>Ex 6.5.2.2. Modify your code to utilize a full descending stack. Sorting must be done on the<br />
<div class="outline-text-5" id="text-6-3-2-1">
<p>
 stack only. Once the stack is sorted, store the sorted stack back to the original
array of memory locations starting at 0x4001.
</p>

<p>
The algorithm for the bubble sort is as follows:
a. Compare adjacent elements. If the first element is greater than the second,
swap them.
</p>

<p>
b. Do this for each pair of adjacent elements, starting with the first two and
     ending with the last two. At this point the last element should be the
    greatest.
c. Repeat the steps for all elements except the last one.
d. Repeat this process for one fewer element each time, until you have no
more pairs to compare.
</p>

<p>
Dado que eh muito confuso, nao estarei cobrando esse uso de pilha. 
Podem pular esse item 6.5.2.-2.
Entretanto, seguem observacoes colhidas ao longo do curso. Porem, pulem esse item:
</p>

<p>
Está confuso como utilizar o full descending stack - uma forma de organizar usando pilha somente é torre de Hannoy mas usando o bubble sort estamos mexendo em elmentos de uma array. Uma idéia é: trabalha com duas estruturas - uma array onde se descobre o maior e a pilha que vai armazenando o maior elemento em cada iteracao. Observar que a array eh de bytes enquanto que a pilha eh de words (o mais simples eh desperdicar memoria ao usar os bytes como words).
Outra idéia (grupo Joao) - usar duas pilhas. A pilha eh varrida a cada comparacao jogando o maior valor para a segunda pilha. Na primeira pilha sobre o menor valor. A segunda pilha com N-1 elementos é totalmente trasportada para a primeira pilha. O processo se repete para os N-1 elementos da primeira pilha.
</p>
</div>
</li>
</ol>
</div>


<div id="outline-container-orgd2c619b" class="outline-4">
<h4 id="orgd2c619b"><span class="section-number-4">6.3.3</span> Ex 6.5.3</h4>
<div class="outline-text-4" id="text-6-3-3">
<p>
Quadrado Magico
Nao é necessário preocupar-se em colocar o quadrado mágico em 0x4000. É mais fácil declarar na memória ao final do programa algo como .word 1,4, &#x2026; colocando as words do quadrado mágico.
</p>
</div>
</div>

<div id="outline-container-orgb8460e7" class="outline-4">
<h4 id="orgb8460e7"><span class="section-number-4">6.3.4</span> Ex 6.5.4</h4>
<div class="outline-text-4" id="text-6-3-4">
<p>
More stacks
Write ARM assembly to implement a push operation without the use of load/store
multiple instructions. Write the code to handle bytes, half-words, and words. Use r0 to
indicate the data type. A value of 1 in r0 indicates that a byte is to be pushed, 2 indicates
a half-word, and 4 indicates a word. Put the data to push in r1.
</p>

<p>
Lembrar que sp eh sempre um multiplo de 4. Tem que tomar um certo cuidado ao empilhar byte ou half word para que o sp permaneca multiplo de 4; ou seja, dependendo do caso a memoria eh desperdicada. 
</p>

<p>
O mais facil eh sempre alocar 4 bytes mesmo que seja para um byte apenas, desperdicando memoria. Se quiser fazer dessa forma bem facil, faca.
</p>

<p>
O mais dificil eh ir alocando memoria dependendo do tipo de dado, economizando memoria. Para byte, empilha no topo da pilha sempre; para half word, empilha no endereco multiplo de 2 mais proximo do topo; para word, empilha no endereco multiplo de 4 mais proximo do topo da pilha. Nao eh necessario ir para essa solucao mais dificil pois ainda teriamos o problema de como desempilhar sem dar problemas.
</p>

<p>
Dica para olhar a pilha no gdb:
</p>
<pre class="example">
x/20 $sp
</pre>
</div>
</div>
</div>


<div id="outline-container-orged6fd36" class="outline-3">
<h3 id="orged6fd36"><span class="section-number-3">6.4</span> Envie respondendo aas tarefas do google classroom.</h3>
<div class="outline-text-3" id="text-6-4">
</div>
<div id="outline-container-orgc355710" class="outline-4">
<h4 id="orgc355710"><span class="section-number-4">6.4.1</span> Entrega dos arquivos fontes (feito em grupo, entrega individual) + relatorio.</h4>
<div class="outline-text-4" id="text-6-4-1">
<ul class="org-ul">
<li>Entregue no dia da aula os codigos fontes de cada exercicio anexando o arquivo um a um. NAO ZIPEM. No cabecalho de cada codigo, escreva como o arquivo deve ser gerado. Comente o codigo para voce mesmo entender na hora da prova. Caso tenha feito algum script para geracao do codigo (recomendado), anexe o script em seu codigo. Embora o codigo seja feito em grupo, a entrega eh INDIVDUAL.</li>

<li>Relatorio em Formato: pdf. Entregue o relatorio (pdf) cada exercicio por seu grupo, com o codigo e screenshot da tela do gdb. Embora o relatorio seja feito em grupo, a entrega eh INDIVDUAL.</li>
</ul>
</div>
</div>


<div id="outline-container-org0222348" class="outline-4">
<h4 id="org0222348"><span class="section-number-4">6.4.2</span> Entrega da saida do gdb (INDIVIDUAL)</h4>
<div class="outline-text-4" id="text-6-4-2">
<p>
O gdb pode gerar um arquivo contendo a saida sem que seja necessario rodar interativamente o gdb. Por exemplo:
</p>
<ul class="org-ul">
<li>Ao rodar:  arm-elf-gdb  &#x2013;command=comandos.txt a.out :</li>
</ul>

<pre class="example">
# arquivo: comandos.txt
# gera: gdb.txt - saida do gdb 
# arm-elf-gdb  --command=comandos.txt a.out
target sim
load
b main
r
b fim # breakpoint no SWI
c
set logging on
x/16d quadrado # quadrado 4x4
x/d ehmagico # 1- magico 0 - nao eh magico
set logging off
</pre>

<p>
temos a saida gravada em gdb.txt que vc. deve anexar como retorno dessa atividade.
</p>


<p>
Apresente o gdb.txt de 6.5.3 Magic squares. Ao inves de usar a posicao 0x4000, coloque o quadrado magico jah definido no seu codigo em na label "quadrado"(como jah vimos em aulas passadas). 
A experiencia eh sobre rotinas assim, CRIE SUBROTINAS para verificar a soma na horizontal, vertical e diagonal. 
Entregue:
</p>

<ol class="org-ol">
<li>gdb.txt 1 - Teste com o quadrado magico da apostila 4x4 e apresente o printscreen.</li>

<li>gdb.txt 2 - procure na internet um quadrado magico 3x3, teste e apresente o printscreen. Observe que ao inves de x/16d quadrado, vc deve fazer x/9d quadrado</li>

<li>gdb.txt 3 - Preencha esse quadrado magico 3x3 com apenas o numero 5 (ou seja, quadrado .word 5,5,5,5,5&#x2026;). O que voce obteve?</li>
</ol>
<p>
Se obteve como resposta quadrado magico estah errado pela definicao de quadrado magico. Assim, pense no algoritmo mais eficiente possivel para verificar se temos os numeros de 1 a N**2 e o implemente. Dica: esse algoritmo eh da ordem de NE (numero de elementos em quadrado) e nao de NE**2. Apresente o printscreen3 testando com o quadrado 3x3 contendo apenas 5's (mostrando que ele nao eh quadrado magico).
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org482c47a" class="outline-2">
<h2 id="org482c47a"><span class="section-number-2">7</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-06-24 qui&gt; </span></span> . P1 - Subroutines (cap6)</h2>
<div class="outline-text-2" id="text-7">
<p>
prova a ser enviada por email.
nao entrem no google meet.
</p>
</div>
</div>


<div id="outline-container-orgfdb82e5" class="outline-2">
<h2 id="orgfdb82e5"><span class="section-number-2">8</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-07-01 qui&gt; </span></span> . E8: C compiler + assembler - juntar C com assembly.</h2>
<div class="outline-text-2" id="text-8">
<div id="text-table-of-contents">
<ul>
<li><a href="#org231b712">8.1. PLANEJAMENTO (individual): file:/home/jk/docker-labmicro/gcc-arm/src/imprime.c</a></li>
<li><a href="#org125c1d0">8.2. Objetivos da aula de hoje:</a>
<ul>
<li><a href="#orga3270c5">8.2.1. compilar codigo assembly e codigo C e linkar ambos.</a></li>
<li><a href="#org624e901">8.2.2. alterar o codigo C inserindo assembly no meio do código C.</a></li>
<li><a href="#orga169828">8.2.3. observar como funciona a recursao.</a></li>
</ul>
</li>
<li><a href="#org43c03f8">8.3. Envie respondendo aas tarefas do google classroom.</a>
<ul>
<li><a href="#org8c1348b">8.3.1. Entrega dos arquivos fontes (feito em grupo, entrega individual) e Entrega de relatorio (feito em grupo, entrega individual)</a></li>
<li><a href="#org1a90e7a">8.3.2. Entrega de printscreen (INDIVIDUAL)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org231b712" class="outline-3">
<h3 id="org231b712"><span class="section-number-3">8.1</span> PLANEJAMENTO (individual): <a href="file:///home/jk/docker-labmicro/gcc-arm/src/imprime.c">file:///home/jk/docker-labmicro/gcc-arm/src/imprime.c</a></h3>
<div class="outline-text-3" id="text-8-1">
<p>
Crie um programa em C (imprime.c) que faz uma contagem de 5 a 0 usando uma funcao recursiva do tipo:
</p>

<pre class="example">
void imprime(N) {
  if (N&lt;0) {
    return;
  }
  printf("numero = %d\n", N);
  imprime(N-1);
}


int main(void ) {
     imprime(5);
}
</pre>

<p>
Crie de fato o programa em C e compile em casa antes da aula. Faca o compilador gerar o código assembly imprime.s através de
</p>
<pre class="example">
arm-elf-gcc –S imprime.c
</pre>


<p>
Referencias que podem ajudar:
</p>

<p>
<a href="http://www.cl.cam.ac.uk/~fms27/teaching/2001-02/arm-project/02-sort/apcs.txt">http://www.cl.cam.ac.uk/~fms27/teaching/2001-02/arm-project/02-sort/apcs.txt</a>
</p>

<p>
<a href="http://stackoverflow.com/questions/15752188/arm-link-register-and-frame-pointer">http://stackoverflow.com/questions/15752188/arm-link-register-and-frame-pointer</a>
</p>



<p>
Estude o código e simule a pilha e responda no planejamento:
</p>
<ul class="org-ul">
<li>Como a funcao imprime estah usando a pilha para fazer a chamada recursiva? Apresente a explicacao de como a pilha estah sendo usada (simule desenhando a pilha usando o fp, ip, sp) para fazer a chamada recursiva.</li>
<li>como o valor N eh passado como parametro para imprime() em main? via registrador ou pilha?</li>
<li>para que serve o frame pointer?</li>
<li>como o valor N eh referenciado dentro de imprime.s (vindo do compilador)? Relacione onde estah N com o fp.</li>
<li>observe que voltamos de uma instancia imprime para a instancia anterior atraves da instrucao ldmfd. Alguns alunos observaram que, durante o debug no gdb, o step (s) parece nao ter executado de forma correta e aparentemente, ele retorna de todas as instancias chamadas de uma vez. Se vc. quiser observar apenas um retorno de cada vez, noa use "s" e sim "si" ("step instruction" que executa instrucao a instrucao) como observeu o Artur/coop21.</li>
</ul>
</div>
</div>

<div id="outline-container-org125c1d0" class="outline-3">
<h3 id="org125c1d0"><span class="section-number-3">8.2</span> Objetivos da aula de hoje:</h3>
<div class="outline-text-3" id="text-8-2">
<ol class="org-ol">
<li>compilar codigo assembly e codigo C e linkar ambos.</li>
<li>alterar o codigo C inserindo assembly no meio do código C.</li>
<li>observar como funciona a recursao e gerar um relatorio usando o libreoffice com os printscreens da tela do arm-elf-gdb.</li>
</ol>

<p>
RELATORIO:
Crie um documento (ex: usando o libreoffice) anexando os printscreens com uma explicacao do que ocorre ao seguirem os itens abaixo.
Como diversas instrucoes alteram a pilha, vc. pode observar a pilha fazendo:
x/16 $sp
</p>
</div>


<div id="outline-container-orga3270c5" class="outline-4">
<h4 id="orga3270c5"><span class="section-number-4">8.2.1</span> compilar codigo assembly e codigo C e linkar ambos.</h4>
<div class="outline-text-4" id="text-8-2-1">
<p>
Adaptei de <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.100748_0606_00_en/lmi1470147220260.html">http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.100748_0606_00_en/lmi1470147220260.html</a> o codigo seguinte:
</p>

<p>
arquivo: <a href="file:///home/jk/docker-labmicro/gcc-arm/src/add.s">file:///home/jk/docker-labmicro/gcc-arm/src/add.s</a>
</p>
<pre class="example">
	.text
	.globl   myadd
			
myadd:                     	@ Function "myadd" entry point.
	add      r0, r0, r1   	@ Function arguments are in R0 and R1. Add together and put the result in R0.
	mov	pc, lr           @  Return by branching to the address in the link register.
</pre>

<p>
arquivo: <a href="file:///home/jk/docker-labmicro/gcc-arm/src/main.c">file:///home/jk/docker-labmicro/gcc-arm/src/main.c</a>
</p>
<pre class="example">
#include &lt;stdio.h&gt;
					
extern int myadd(int a, int b);
					
int main()
{
	int a = 4;
	int b = 5;
	printf("Adding %d and %d results in %d\n", a, b, myadd(a, b));
	return (0);
}
</pre>

<p>
Observe que o codigo em C chama myadd que estah em assembly. No assembly, a funcao myadd recebe os parametros em R0 e R1 e retorna o resultado em R0. Existe uma convencao em como o C passa os parametros para uma funcao em assembly e como recebe o retorno da funcao. Veja "Chapter 2. Using the Procedure Call Standard" em <a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0056d/DUI0056.pdf">http://infocenter.arm.com/help/topic/com.arm.doc.dui0056d/DUI0056.pdf</a>
</p>

<p>
Para compilar:
</p>

<pre class="example">
student:~/src$ gcc add.s main.c
</pre>

<p>
que gera o codigo a.out
</p>

<p>
Fazendo gdb a.out : 
</p>
<pre class="example">
Loading section .jcr, size 0x4 vma 0x1097c
Start address 0x8110
Transfer rate: 139776 bits/sec.
(gdb) b main
Breakpoint 1 at 0x8230: file main.c, line 7.
(gdb) r
Starting program: /home/student/src/a.out 

Breakpoint 1, main () at main.c:7
(gdb) n
Adding 4 and 5 results in 9
(gdb) 
</pre>

<p>
Repita o que foi feito, criando o seu primeiro codigo que mistura C e assembly.
</p>
</div>

<ol class="org-ol">
<li><a id="org8701924"></a>int2str<br />
<div class="outline-text-5" id="text-8-2-1-1">
<p>
Crie a funcao em assembly int2str(inteiro, pontstr) que transforma um inteiro em uma string. 
Por exemplo: o inteiro 1 deve ser transformado na sequencia de bytes 0x31 , 0x0 ; pois o zero representa o final da string.
A string deve ser colocado no ponteiro apontado por pontstr.
</p>

<p>
Use a rotina de divisao da E3 para dividir o numero por 10 e ir montando a string.
Exemplo, supondo que inteiro =123
esse valor eh dividido por 10 com resto 3 ; 
soma 3 com 0x30 (para formar o caracter ASCII '3').
coloca o 0x33 em pontstr.
</p>

<p>
depois dividido por 10 com resto 2 
gera 0x32 ; move todos os bytes para direito dentro de pontstr e
insere 0 0x33 em pontstr.
</p>

<p>
dividido por 10 com resto 1.
repete formando a sequencia de bytes 0x31, 0x32, 0x33, 0 que sao colocadas partir de pontstr.
</p>


<p>
Crie uma funcao em C (main) impnum(int num):
entrada: num - numero
imprime o numero que recebeu em decimal. Para converter o numero deve usar a rotina assembly int2str. Dica: use "puts".
</p>

<p>
Teste a sua funcao.
</p>



<p>
PRINTSCREEN: 
tire um printscreen de sua tela logo depois que o numero eh impresso pela funcao em C. Teste com seu numero usp. 
</p>
</div>
</li>


<li><a id="orga6954b2"></a>adapte em imprime.c<br />
<div class="outline-text-5" id="text-8-2-1-2">
<p>
Altere a funcao imprime em imprime.c usado no planejamento trocando o printf por chamadas de puts e int2str 
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-org624e901" class="outline-4">
<h4 id="org624e901"><span class="section-number-4">8.2.2</span> alterar o codigo C inserindo assembly no meio do código C.</h4>
<div class="outline-text-4" id="text-8-2-2">
</div>
<ol class="org-ol">
<li><a id="orga7b9b89"></a>Estude o codigo imprime.s vindo de imprime.C<br />
<div class="outline-text-5" id="text-8-2-2-1">
<p>
No seu relatorio responda:
</p>

<hr />
<p>
Existe algum formato para os labels gerados automaticamente em imprime.s?
</p>
<hr />
<p>
Observe que as labels geradas automaticamente seguem um padrao como .L(\d+) ou seja ".L" seguido de digitos. Eh importante observar isso porque ao inserir qualquer codigo em assembly, voce nao poderah inserir labels desse tipo pois voce nao tem o controle sobre como o compilador funciona.
</p>

<hr />
<p>
Como o numero eh passado como parametro? Como o fp é usado para isso? 
</p>
<hr />

<p>
Em uma funcao, os registradores poderiam ser salvos e recuperados chamados assim:
</p>
<pre class="example">
BL myfunction
myfunction
           .....
           STMFD sp!, {r4-r10, lr}; guarda os registradores
           .....
           .....
           LDMFD sp!, {r4-r10, pc}; recupera os registradores; o retorno da funcao eh feito colocando lr em pc.
</pre>


<p>
Para entender melhor como funciona a chamada de rotinas, veja:
<a href="http://infocenter.arm.com%2fhelp%2ftopic%2fcom.arm.doc.ihi0042d%2fihi0042d_aapcs.pdf">http://infocenter.arm.com%2fhelp%2ftopic%2fcom.arm.doc.ihi0042d%2fihi0042d_aapcs.pdf</a>
Responda no relatorio:
</p>
<hr />
<p>
Quais sao os registradores atribuidos a: fp, ip, sp, lr?
</p>

<p>
Para que serve o fp?
</p>

<hr />

<p>
A seguinte pergunta nao precisa ir para o seu relatorio. Se vc. tiver uma boa ideia sobre a resposta (porque trabalha com compiladores) discuta a resposta comigo ou coloque no mural da disciplina.
</p>

<hr />
<p>
Para que serve o ip? 
</p>
<hr />
<p>
A resposta na internet eh confusa: 
</p>

<p>
Register r12 (IP) may be used by a linker as a scratch register between a routine and any subroutine it calls (for details, see §5.3.1.1, Use of IP by the linker). It can also be used within a routine to hold intermediate values
between subroutine calls.
Essa resposta eh extremamente confusa, mas eh o que estah escrito em aapcs.pdf. Em: <a href="https://stackoverflow.com/questions/16120123/arm-why-do-i-need-to-push-pop-two-registers-at-function-calls">https://stackoverflow.com/questions/16120123/arm-why-do-i-need-to-push-pop-two-registers-at-function-calls</a> temos que a ARM quer o alinhamento de 8 bytes na memoria (para o ARM 64 bits) Isso explica o motivo de se ter um registrador scratch (r12, ip) colocado na pilha - porque do ponto de vista da recursao em si, nao faz sentido&#x2026;
Dentre os 2 registradores fp e ip, o mais confuso eh o ip, sem duvida e eh chamdado de Intra-Procedure-call scratch register.  <a href="https://community.arm.com/developer/tools-software/oss-platforms/f/dev-platforms-forum/5436/i-want-to-know-meaning-of-r12-register">https://community.arm.com/developer/tools-software/oss-platforms/f/dev-platforms-forum/5436/i-want-to-know-meaning-of-r12-register</a>
</p>
</div>
</li>

<li><a id="org61bf310"></a>Inserindo assembly no meio do codigo C<br />
<div class="outline-text-5" id="text-8-2-2-2">
<p>
Para inserir codigo assembly no meio do codigo C (imprime.c), pode-se usar "inline assembly code" como no exemplo a seguir (ver: <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.100748_0606_00_en/ddx1471430827125.html">http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.100748_0606_00_en/ddx1471430827125.html</a>) :
</p>

<pre class="example">
__asm__( 
 "ldr r3, [fp, #-16]\n\t
 "mov r0,r1\n\t"
);
</pre>

<p>
onde cada linha corresponde a umsa intrucao assembly.
Obviamente eh MUITO ARRISCADO mexer nos registradores dessa forma, pois o C tambem estah usando-os e qualquer alteracao pode causar erros no seu codigo. Apesar dessa ressalva, vamos alterar um ou outro registrador nesse item.
</p>

<p>
Em C temos variaveis locais e variaveis globais.
As variaveis locais sao definidas na pilha e para o C qualquer funcao pode ser recursiva.
As variaveis globais sao definidas em posicoes fixas na memoria.
</p>

<p>
Assim, vamos definir a variavel global "mostra" no seu codigo em C como:
</p>

<pre class="example">
int mostra;
</pre>
<p>
e atribuir o valor 1 logo no comeco do seu codigo.
Veja o assembly gerado pelo c, atraves da opcao -S e procure entender como o valor 1 foi atribuido aa variavel mostra.
No relatorio coloque o codigo correspondente aa essa atribuicao e explique (dica: veja str).
</p>

<p>
Observe que o codigo em assembly gera um monte de labels que comecam com ponto (ex: .L2). Muito provavelmente, o assembly gerado usa um destes labels para atribuir 1 aa variavel mostra. Quando voce usar o "inline assembly", voce NAO DEVE usar nenhum label como .L2 pois isso iria se misturar com os labels gerados pelo C. Assim, o desafio eh:
</p>

<p>
Escreva em assembly, um codigo referente a "mostra = 1" usando inline assembly (ou seja, usando <span class="underline"><span class="underline">asm</span></span>) . Verifique no gdb que o valor foi devidamente escrito. Dica: Use as instrucoes em assembly LDR e STR e lembre-se de que as vezes fazemos LDR &#x2026;, =  (na duvida veja a aula sobre LDR e STR), para isso voce precisarah no maximo de 3 instrucoes: 2 para acertar registradores e 1 para o STR. Voce tambem nao deve fazer algo como .word&#x2026;. declarando um ponteiro, copiando o que foi feito pelo compilador C.
Dentro do gdb, para saber o valor de mostra basta fazer:
</p>
<pre class="example">
p mostra
</pre>
<p>
Se tiver duvida de que as coisas estao funcionando, experimente variar o valor a ser colocado em "mostra" e verifique se o "p mostra" varia de acordo.
</p>

<p>
Para saber a posicao de memoria onde foi parar a variavel "mostra" eh necessario gerarmos a tabela de simbolos. Supondo que o codigo gerado seja a.out entao podemos fazer:
</p>

<pre class="example">
student:~/src$ arm-elf-objdump -t a.out|grep mostra
00010ab8 g     O .bss	00000004 mostra

OU

student:~/src$ arm-elf-nm a.out | grep mostra
00010ab8 B mostra
</pre>

<p>
A posicao 0x10ab8 corresponde ao endereco da variavel "mostra". Verifique se essa posicao foi alterada ao rodar o codigo no gdb.
</p>
</div>
</li>
</ol>
</div>


<div id="outline-container-orga169828" class="outline-4">
<h4 id="orga169828"><span class="section-number-4">8.2.3</span> observar como funciona a recursao.</h4>
<div class="outline-text-4" id="text-8-2-3">
</div>
<ol class="org-ol">
<li><a id="org6d0e0e3"></a>Observe como o imprime do pre-lab imprime um caracter no codigo assembly (gerado ao compilar .c com -S).<br />
<div class="outline-text-5" id="text-8-2-3-1">
<p>
Utilizando o gdb observe como o fp, ip e sp são utilizados em:
</p>
<pre class="example">
stmfd sp!, {fp, ip, lr, pc}
</pre>

<p>
e como sao desempilhados em:
</p>
<pre class="example">
ldmfd sp, {r3, fp, sp, pc}
</pre>


<p>
O arm-elf-gcc estah primeiro passando os parametros por registradores e depois empilhando-os dentro da rotina, por isso os parametros sao acessado via [fp - Numero] pois foram empilhados depois da entrada da rotina que empilhou ip, sp, fp. Supondo que uma funcao tenha 5 parametros, a funcao terah que obrigatoriamente empilhar alguns antes da chamada da rotina e esses parametros vao ser acessados via [fp + Numero]. Verifique colocando 5 parametros na funcao recursiva. Observe como eles sao empilhados e acessados.
</p>


<p>
Observe que entre o stmfd e o ldmfd, o sp é alterado; por isso lr eh repassado para o pc.
</p>

<p>
O grupo do Lucas,Ricardo,Gabriel,Jonatas enviaram uma foto de como a pilha se comporta quando nas chamadas recursiva em:
<img src="https://www2.pcs.usp.br/~jkinoshi/2017/pilha.PNG" alt="pilha.PNG" />
</p>


<p>
Perguntas:
Como o parametro é passado para imprime? Na resposta explique o caso da rotina ter 5 parametros (via registrador e pilha) e da rotina ter poucos parametros (via registrador).
</p>

<p>
Como esse parametro é empilhado (isso é necessário em caso de chamadas recursivas)? Como é aberto um espaco na pilha para o parametro de imprime? Onde isso é feito no código?
</p>

<p>
Por que se faz fp-16 para acessar o parametro?  
</p>

<p>
Como esse parametro é desempilhado? Observe que o ip eh repassado para sp e com isso, a alteracao na pilha para abrir o espaco para o parametro de "imprime" é automaticamente refeito. 
</p>

<p>
Para o seu relatorio, gere imagens semelhantes aas apresentadas pelo grupo do Lucas,Ricardo,Gabriel,Jonatas.
</p>
</div>

<ol class="org-ol">
<li><a id="org502d758"></a>Declare a variavel local "int lixo"  na funcao imprime.<br />
<div class="outline-text-6" id="text-8-2-3-1-1">
<p>
Dentro da funcao recursiva faca, lixo++. Observe o codigo assembly gerado pelo compilador. Responda no relatorio: Como lixo foi referenciado? Como foi aberto espaco na pilha para o lixo? Retire printscreens comparando a pilha sem o uso do int lixo e com o uso de int lixo. Variaveis locais devem ser empilhadas pois caso, a funcao seja recursiva elas fazem parte da recursao.
</p>
</div>
</li>
</ol>
</li>

<li><a id="org6514bb8"></a>Crie imprime.s para que imprima 7 numeros de 1 a 7<br />
<div class="outline-text-5" id="text-8-2-3-2">
<p>
Gere o codigo imprime.s. 
Estude como o fp (frame pointer) eh usado para marcar uma posicao na pilha empilhando parametros e variaveis locais. Apresente no relatorio como a pilha e o fp estao sendo usados. 
</p>

<p>
Rode essa versao de imprime no gdb. 
Retire printscreen antes e depois de cada instrucao que faz alteracao na pilha, em particular:
</p>
<pre class="example">
stmfd sp!, {fp, ip, lr, pc}
ldmfd sp, {r3, fp, sp, pc}
</pre>

<p>
Pergunta:
Quando imprime chama recursivamente imprime é necessário que o haja um ponteiro para o fp anterior. Como isso é feito?
Quando imprime retorna para uma instancia anterior é necessário ue o fp retorne para servir de base para os parametros e variaveis locais anteriores. Explique como isso é feito.
</p>

<p>
Ao final da aula, enviar email ao professor contendo o documento gerado com os printscreens. Para ver a pilha no gdb faca
x/16 $sp
</p>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-org43c03f8" class="outline-3">
<h3 id="org43c03f8"><span class="section-number-3">8.3</span> Envie respondendo aas tarefas do google classroom.</h3>
<div class="outline-text-3" id="text-8-3">
</div>
<div id="outline-container-org8c1348b" class="outline-4">
<h4 id="org8c1348b"><span class="section-number-4">8.3.1</span> Entrega dos arquivos fontes (feito em grupo, entrega individual) e Entrega de relatorio (feito em grupo, entrega individual)</h4>
<div class="outline-text-4" id="text-8-3-1">
<p>
Entregue no dia da aula os codigos fontes de cada exercicio um a um (ou seja entre arquivos .s e .c). No cabecalho de cada codigo, escreva como o arquivo deve ser gerado. Comente o codigo para voce mesmo entender na hora da prova. Caso tenha feito algum script para geracao do codigo (recomendado), anexe o script em seu codigo. Embora o codigo seja feito em grupo, a entrega eh INDIVDUAL.
</p>

<p>
Formato: pdf. Entregue ateh o final do dia aula o relatorio (pdf) cada exercicio por seu grupo, com o codigo e screenshot do tela do gdb. Embora o relatorio seja feito em grupo, a entrega eh INDIVDUAL. 
</p>
</div>
</div>


<div id="outline-container-org1a90e7a" class="outline-4">
<h4 id="org1a90e7a"><span class="section-number-4">8.3.2</span> Entrega de printscreen (INDIVIDUAL)</h4>
<div class="outline-text-4" id="text-8-3-2">
<ul class="org-ul">
<li>PRINTSCREEN1:</li>
</ul>
<p>
tire um printscreen de sua tela logo depois que o numero eh impresso pela funcao em C usando int2str. Teste com seu numero usp.
</p>

<ul class="org-ul">
<li>PRINTSCREEN2</li>
</ul>
<p>
mostre a variavel mostra sendo alterada pelo inline assembly.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org6ffdbac" class="outline-2">
<h2 id="org6ffdbac"><span class="section-number-2">9</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-07-08 qui&gt; </span></span> . E9: Hello World for bare metal</h2>
<div class="outline-text-2" id="text-9">
<div id="text-table-of-contents">
<ul>
<li><a href="#org381ea30">9.1. Planejamento (individual):</a></li>
<li><a href="#org2861925">9.2. Experiencia</a>
<ul>
<li><a href="#org3390a35">9.2.1. Rode o Simplest Bare Metal Program</a></li>
<li><a href="#org9ed1452">9.2.2. Imprima "Hello World" na placa versatile emula pelo qemu</a></li>
<li><a href="#org0b91233">9.2.3. tratando a instrucao invalida em startup.s</a></li>
<li><a href="#org6b3da8f">9.2.4. Um Undefined Handler simples, porem errado.</a></li>
<li><a href="#orgb658364">9.2.5. A pilha no Undefined mode.</a></li>
<li><a href="#orgcd951d8">9.2.6. Undefined handler</a></li>
<li><a href="#org4e9c233">9.2.7. modo kernel x modo usuario</a></li>
</ul>
</li>
<li><a href="#org755d2f1">9.3. Envie respondendo aas tarefas do google classroom.</a>
<ul>
<li><a href="#org13ce239">9.3.1. Entrega dos arquivos fontes (feito em grupo, entrega individual) + relatorio</a></li>
<li><a href="#org16ccbb1">9.3.2. Entrega de printscreen (INDIVIDUAL)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org381ea30" class="outline-3">
<h3 id="org381ea30"><span class="section-number-3">9.1</span> Planejamento (individual):</h3>
<div class="outline-text-3" id="text-9-1">
<p>
daqui para o final do curso, vamos utilizar a placa versatile emulada (similar ao evaluator7t mas emulada pelo qemu); comecando por uma placa sem absolutamente nada de software (bare metal), ou seja, sem o software que faz o boot.
</p>

<p>
Leia:
<a href="http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/">http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/</a>
</p>


<p>
Lá lemos:
In order to create a bare metal program we must understand what does the processor do when it is switched on. The ARM9 architecture begins to execute code at a determined address, that could be 0 (usually allocated to RAM) or 0xFFFF0000 (usually allocated to Read Only Memory). We must put some special code at that particular address: the interrupt vector table. 
</p>

<p>
Pesquise e responda como planejamento (em pdf):
</p>
<ol class="org-ol">
<li>Como o ARM9 decide se a primeira instrucao a executar está em zero ou em 0xFFFF0000? A resposta estah no site do ARM.</li>
<li>Compile os códigos em casa antes da aula e tente rodar usando o arm-elf-&#x2026; (gcc, gdb, etc. - normal que estamos usando) ao inves de arm-none-&#x2026; que estah no post simplest-bare-metal-program-for-arm. Voce conseguiu observar o código usando arm-elf-gdb em casa? Voce conseguiu executar c<sub>entry</sub>?</li>
<li>Pesquise na internet (manual do GNU) e responda, o que faz test.ld (o script para o comando ld, mais especificamente arm&#x2026;ld) ?</li>
</ol>
<p>
O que significa em test.ld:
</p>
<pre class="example">
3.1) - ENTRY(_Reset)
3.2)- startup.o (INTERRUPT_VECTOR)
3.3) - stack_top = .;
3.4) - .bss : { *(.bss) }
3.5) - . = . + 0x1000; /* 4kB of stack memory */
</pre>


<pre class="example">
#------------------ test.ld ----------------
ENTRY(_Reset)
SECTIONS
{
 . = 0x0;
 .text : {
 startup.o (INTERRUPT_VECTOR)
 *(.text)
 }
 .data : { *(.data) }
 .bss : { *(.bss) }
 . = . + 0x1000; /* 4kB of stack memory */
 stack_top = .;
}
#------------------ test.ld ----------------
</pre>
</div>
</div>



<div id="outline-container-org2861925" class="outline-3">
<h3 id="org2861925"><span class="section-number-3">9.2</span> Experiencia</h3>
<div class="outline-text-3" id="text-9-2">
<p>
Como a placa Versatile (similar ao evaluator7t do laboratorio) pode imprimir um "hello world" ao bootar?
O processador ARM, ao ser ligado, passa a executar código a partir da posicao zero.
Nessa posicao, vamos colocar o vetor de interrupcao.
Para isso precisamos de gravar uma EPROM que contenha um jump na posicao zero para a rotina que imprime o hello world. Como não temos nenhum software, é necessário criar a rotina que faz a impressao da string via serial.
Para essa experiencia, leia:
</p>

<p>
<a href="http://balau82.wordpress.com/2010/02/28/hello-world-for-bare-metal-arm-using-qemu/">http://balau82.wordpress.com/2010/02/28/hello-world-for-bare-metal-arm-using-qemu/</a>
Nesse post, o Balau explica como fazer a rotina C<sub>entry</sub> que nao contem nada para ser executada como se uma placa com o processador ARM9 estivesse sendo bootada. Ele mostra como fazer isso no simulador. O vetor de interrupcao estah na posicao correta (que existe) 0x1000.
</p>

<p>
<a href="http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/">http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/</a>
Nesse post, o Balau explica como se imprime "Hello World" de uma Versatile emulada pelo qemu; porém com o código rodando a partir de 0x0 e não a partir do zero como seria de se esperar do "bare metal" de fato.
</p>


<p>
<a href="http://www.embedded.com/design/mcus-processors-and-socs/4007119/Building-Bare-Metal-ARM-Systems-with-GNU-Part-1--Getting-Started">http://www.embedded.com/design/mcus-processors-and-socs/4007119/Building-Bare-Metal-ARM-Systems-with-GNU-Part-1--Getting-Started</a>
</p>

<p>
Um excelente artigo explicando como colocar software sobre o hardware usando GNU.
</p>

<p>
Realize os passos abaixo para a aula de hoje. Em paralelo, construa um relatorio para enviar no final da aula. Anexe código e printscreens do qemu, principalmente ao se constatar a mudanca de modo de processamento. 
</p>

<p>
Para a aula faça:
</p>
</div>

<div id="outline-container-org3390a35" class="outline-4">
<h4 id="org3390a35"><span class="section-number-4">9.2.1</span> Rode o Simplest Bare Metal Program</h4>
<div class="outline-text-4" id="text-9-2-1">
<p>
O grande objetivo da aula de hoje eh entender o vetor de interrupcao. Para a aula de hoje, ele deve obrigatoriamente ser posicionado em zero. 
Uma forma de declarah-lo em assembly eh:
</p>

<pre class="example">
.section INTERRUPT_VECTOR, "x"
.global _Reset
_Reset:
  B Reset_Handler /* Reset */
  B . /* Undefined */
  B . /* SWI */
  B . /* Prefetch Abort */
  B . /* Data Abort */
  B . /* reserved */
  B . /* IRQ */
  B . /* FIQ */
 
Reset_Handler:
  LDR sp, =stack_top
  BL c_entry
  B .
</pre>
<p>
O vetor de interrupcao eh defindo pela ARM. 
Quando a placa eh resetada, o PC eh colocado na posicao zero. Quando uma instrucao indefinida for encontrada dentro de um codigo, o PC recebe 4; quando ele executar uma instrucao SWI (ou svc), o PC recebe 8 e assim por diante. Por isso, devemos ter os Branchs (B) para o tratamento de cada excessao.
</p>


<p>
Vamos rodar o programa em  <a href="http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/">http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/</a> usando <a href="http://linux-kernel-lab.blogspot.com/2018/04/basics-on-arm-processor.html">http://linux-kernel-lab.blogspot.com/2018/04/basics-on-arm-processor.html</a> . Nao serah necessario instalar nada, pois temos tudo nessa imagem (qemu e arm-none).
</p>

<p>
e rode esse programa. O interessante é o startup.s que contém a inicializacao do vetor de interrupcao e faz o codigo rodar a partir da posicao zero. O problema eh que nesse post, nao existe nada impresso.
</p>

<p>
No README.md de <a href="https://github.com/EpicEric/gcc-arm.git">https://github.com/EpicEric/gcc-arm.git</a> lemos como gerar os programas e rodah-los: 
</p>

<pre class="example">
### Regular program

```
eabi-gcc c_entry.c -o c_entry.o
eabi-as startup.s -o startup.o
eabi-ld -T vector_table.ld c_entry.o startup.o -o program.elf
eabi-gdb program.elf
```

### Code on emulated board with QEMU

```
eabi-gcc c_entry.c -o c_entry.o
eabi-as startup.s -o startup.o
eabi-ld -T vector_table.ld c_entry.o startup.o -o program.elf
eabi-bin program.elf program.bin
qemu program.bin
```

In another terminal, open the same container with `./run_docker.sh` (without parameters).

```
eabi-qemu -se program.elf
[gdb] break c_entry
[gdb] continue
[gdb] ...
[gdb] quit
pkill qemu
</pre>

<p>
Siga os passos em <a href="http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/">http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/</a>
e rode esse programa. 
</p>
</div>
</div>

<div id="outline-container-org9ed1452" class="outline-4">
<h4 id="org9ed1452"><span class="section-number-4">9.2.2</span> Imprima "Hello World" na placa versatile emula pelo qemu</h4>
<div class="outline-text-4" id="text-9-2-2">
<p>
A fim de imprimir "Hello World" usando o qemu (target remote:1234), vamos usar 2 posts do Balau:
</p>

<ol class="org-ol">
<li><a href="http://balau82.wordpress.com/2010/02/28/hello-world-for-bare-metal-arm-using-qemu/">http://balau82.wordpress.com/2010/02/28/hello-world-for-bare-metal-arm-using-qemu/</a>
<ul class="org-ul">
<li>usa qemu e imprime string, endereco no vetor de interrupcao = 0x1000</li>
</ul></li>
<li><a href="http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/">http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/</a> - usa simulador e nao imprime nada, endereco do vetor de interrupcao = zero.</li>
</ol>

<p>
O que usa o simulador faz um print e o outro que usa o qemu nao printa nada. Por isso vamos rodar basicamente o segundo post, mas fazendo com que se imprima  "Hello World" como no primeiro post. Portanto, vamos seguir a risca a forma de rodar o codigo do post hello-world-for-bare-metal-arm-using-qemu passando o test.ld e startup.s (com endereco zero) do  segundo post para o primeiro.
</p>


<p>
Observe que em
<a href="http://balau82.wordpress.com/2010/02/28/hello-world-for-bare-metal-arm-using-qemu/">http://balau82.wordpress.com/2010/02/28/hello-world-for-bare-metal-arm-using-qemu/</a>
</p>

<p>
o código passa a executar a partir de 0x1000 e não a partir do zero. Isso nao eh o que ocorre quando se faz o boot de uma placa. Provavelmente o Balau fez dessa forma, porque toda placa/simulador vem com um código em eprom que deve ser emulado que corresponde justamente ao código de boot. O que nos interessa nesse post eh a funcao print<sub>uart0</sub>.
</p>


<p>
Observe que em
<a href="http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/">http://balau82.wordpress.com/2010/02/14/simplest-bare-metal-program-for-arm/</a>
o codigo estah escrito como acontece em uma placa de verdade, no caso a placa versatile que estah sendo emulada pelo qemu. Use test.ld (o ldscript) e statup.s desse post para fazer o código rodar a partir de 0x0 como acontece em uma placa real. Esse post nao explica como fazer a placa imprimir; por isso precisamos do primeiro post.
Observe:
</p>
<ul class="org-ul">
<li>o startup.s desse post contém o vetor de interrupcao na posicao zero.</li>

<li>Quando ativamos o gdb para se contectar com o qemu usando o alias eabi-qmeu; executamos o script em gcc-arm/docker/files/.gdbinit/qemu abaixo. Observe que esse script faz a contexao com o qemu via target remote e apos isso, faz load. Este load irah carregar o seu programa na posicao zero no lugar do firmware da placa.</li>
</ul>
<pre class="example">
layout regs
target remote localhost:1234
load
</pre>


<ul class="org-ul">
<li>usem o test.ld abaixo que coloca o vetor de interrupcao em zero; nao usem o test.ld que coloca na posicao 0x1000.</li>
</ul>
<pre class="example">
ENTRY(_Reset)
SECTIONS
{
 . = 0x0;
 .text : {
 startup.o (INTERRUPT_VECTOR)
 *(.text)
 }
 .data : { *(.data) }
 .bss : { *(.bss COMMON) }
 . = ALIGN(8);
 . = . + 0x1000; /* 4kB of stack memory */
 stack_top = .;
</pre>

<p>
Depois que conseguir imprimir "Hello World" usando o qemu, coloque um breakpoint antes de imprimir o "Hello World" e analise o cpsr. Qual é o modo em que o processador executa? Verifique se está em "Supervisor Mode". Qual é o valor de sp?
</p>

<p>
Consulte o cpsr em:
</p>
<ul class="org-ul">
<li><a href="#orgd64c93b">16.1</a> ARM Laboratory Exercises - apostila - <a href="http://courses.cs.tamu.edu/rabi/cpsc617/resources/ARM%20Lab%20Mannual.pdf">http://courses.cs.tamu.edu/rabi/cpsc617/resources/ARM%20Lab%20Mannual.pdf</a></li>
</ul>
<p>
no capitulo 1, item 1.6.4
</p>
</div>
</div>


<div id="outline-container-org0b91233" class="outline-4">
<h4 id="org0b91233"><span class="section-number-4">9.2.3</span> tratando a instrucao invalida em startup.s</h4>
<div class="outline-text-4" id="text-9-2-3">
<p>
Voltando para <a href="http://balau82.wordpress.com/2010/02/28/hello-world-for-bare-metal-arm-using-qemu/">http://balau82.wordpress.com/2010/02/28/hello-world-for-bare-metal-arm-using-qemu/</a>,
crie a funcao Undefined em C que imprime a string "instrucao invalida!" e fique em um loop infinito. Pendure essa funcao no vetor de interrupcao na posicao correspondente a undefined instruction.
Observe que dentro do gdb é necessário executar o "load"  após o "target". 
</p>

<p>
Toda instrucao corresponde a uma word na memoria. Ex: "MOV R0,R1" corresponde a uma word que pode ser vista como um numero hexadecimal. Alguns numeros fazem sentido (podem ser executados) e outros nao fazem sentido. Por exemplo, a word 0xffffffff eh uma instrucao invalida.
</p>

<p>
Coloque uma instrucao invalida (0xffffffff) em startup.s (com o startup.s inicializando o codigo em 0x0). 
Para isso:
</p>

<pre class="example">
Reset_Handler:
	LDR sp, =stack_top
	BL c_entry
	.word 0xffffffff
	B .
</pre>

<p>
Rode o test.elf com a instrucao invalida. Observe se a string eh impressa. Talvez voce tenha visto um lixo sendo impresso ou o qemu tenha travado o talvez voce tenha visto tudo funcionando bem (por acaso). Vamos corrigir em seguida. 
</p>

<p>
O possivel motivo do lixo impresso foi que o ponteiro de pilha sp no modo undefined nao foi inicializado. Veja a figura 1-2 do ARM Lab Manual. Observe os registradores no modo supervisor e no modo undefined. O registrador R0 no modo supervisor e no modo undefined sao os mesmos porque nao estao marcados (nao estao shaded), assim como a maioria dos outros registradores. Contudo, o registrador R13 (ou sp) e R14 sao diferentes, estao marcados/shaded, dependendo do modo, tanto que o SP no modo supervisor eh chamado de SP<sub>supervisor</sub> e no modo undefined SP<sub>undefined</sub>. Quando o processador passa de um modo para outro, ele passa a usar o SP correspondente ao modo e se ele nao estiver inicializado teremos mproblemas.
</p>


<p>
Coloque um breakpoint antes e depois da instrucao invalida e analise o cpsr. Tente observar a mudanca de modo do processador. Conseguiram? Se sim, observe a mudanca no registrador sp (provavelmente o sp no modo Undefined está zerado ou com um valor qualquer. Verifique isso; portanto, qualquer alteracao de pilha nesse modo pode levar a erros com o sp errado). Se nao conseguiram, vejam o Undefined Handler no proximo item e observem a mudanca de modo dentro do Undefined Handler.
</p>
</div>
</div>

<div id="outline-container-org6b3da8f" class="outline-4">
<h4 id="org6b3da8f"><span class="section-number-4">9.2.4</span> Um Undefined Handler simples, porem errado.</h4>
<div class="outline-text-4" id="text-9-2-4">
<p>
Pendure o seguinte Undefined<sub>Handler</sub> no vetor de interrupcao em startup.s (certifique-se de que o ld script coloca o codigo em 0x0):
</p>
<pre class="example">
Undefined_Handler:
	LDR sp, =stack_top
	BL undefined
</pre>

<p>
Coloque um breakpoint dentro do Undefined<sub>Handler</sub> para observar a mudanca de modo no registrador de status.
</p>

<p>
Existem 2 erros nesse Undefined<sub>Handler</sub>
</p>
<ul class="org-ul">
<li>a pilha nao deve ser inicializada a cada entrada na rotina de excessao. Veja o proximo item - a pilha no Undefined mode.</li>
<li>o retorno estah errado.</li>
</ul>
</div>
</div>

<div id="outline-container-orgb658364" class="outline-4">
<h4 id="orgb658364"><span class="section-number-4">9.2.5</span> A pilha no Undefined mode.</h4>
<div class="outline-text-4" id="text-9-2-5">
<p>
Quando o processador chaveia de modo, o registrador sp de um modo não é o mesmo registrador sp que no outro modo; por isso é necessário inicializar os sp's de todos os modos logo no reset da placa como visto na aula passada.
Veja o item 1.6 "The ARM register set" da apostila de <a href="#orgd64c93b">16.1</a> e observe se existem outros registradores que variam conforme o modo do processador.
Para evitar problema no uso da pilha no modo Undefined, é necessário que Reset<sub>Handler</sub> inicialize também o ponteiro de pilha SP<sub>UNDEF</sub> (registrador sp no modo undefined). Inicilize SP<sub>UNDEF</sub> com o valor 0x2000 e inicialize o SP<sub>SVC</sub> (do supervisor) em 0x1000. Para isso é necessário utilizar a instrucao MSR (Move to Status Register). 
Usando MSR vah para o modo undefined e altere o SP. Esse SP no modo undefined (SP<sub>UNDEF</sub>) eh diferente do SP no modo supervisor. Depois volte ao modo supervisor.
Descubra o número a ser carregado em MSR (observando principalmente o modo e desabilitando as interrupcoes. 
Exemplo de como se altera a pilha:
</p>

<pre class="example">
MRS r0, cpsr    @ salvando o modo corrente em R0
MSR cpsr_ctl, #0b11011011 @ alterando o modo para undefined - o SP eh automaticamente chaveado ao chavear o modo
LDR sp, =undefined_stack_top @ a pilha de undefined eh setada 
MSR cpsr, r0 @ volta para o modo anterior 
</pre>



<p>
Pergunta:
</p>
<ul class="org-ul">
<li>A pilha do Undefined eh inicializada onde?</li>
</ul>
<p>
resposta:
</p>
<ul class="org-ul">
<li>Reset<sub>Handler</sub> pois a pilha do Undefined nao deve ser alterada logo na entrada do Undefined<sub>Handler</sub> - o erro eh semelhante a alterar o topo da pilha ao chamar uma funcao!</li>
</ul>
</div>
</div>

<div id="outline-container-orgcd951d8" class="outline-4">
<h4 id="orgcd951d8"><span class="section-number-4">9.2.6</span> Undefined handler</h4>
<div class="outline-text-4" id="text-9-2-6">
<p>
Refaça o item anterior observando se sp é alterado corretamente na troca de modos.
</p>

<p>
Crie o undefined handler em assembly de forma que ele salve e recupere os registradores. Veja:
</p>

<p>
<a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0471c/Ciheidgb.html">http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0471c/Ciheidgb.html</a>
</p>

<p>
Explique como o processador volta para o modo anterior ao sair do undefined handler.
Rode o programa passo a passo observando os registradores e cpsr sendo salvos e recuperados.
</p>

<p>
A instrucao:
</p>
<pre class="example">
LDMFD sp!,{R0-R12,pc}^
</pre>

<p>
serah a ultima a ser executada pelo undefined<sub>handler</sub>. Ela deve fazer com que o pc continue a partir da instrucao indefinida com o modo anterior (no caso supervisor). Como essa instrucao faz isso?
</p>

<p>
Responda:
</p>
<ul class="org-ul">
<li>por que tem um chapeuzinho no final da instrucao? Para que serve isso?</li>
<li>por que essa instrucao nao salva os registradores sp (ou r13) e r14?</li>
<li>se essa eh a primeira instrucao a ser executada, o sp jah deve ter sido inicializado. Quem fez isso? (voce jah deve ter feito isso logo quando a placa eh incializada usando a instrucao MSR para chavear o modo e inicializar o sp).</li>
</ul>

<p>
Antes de escrever a instrucao de store que salva os registradores no comeco do undefined<sub>handler</sub> coloque um breakpoint na entrada do undefined<sub>handler</sub> e veja onde estah o endereco de retorno. Estah na pilha ou no registrador LR?
Agora acerte o undefined<sub>handler</sub> com as instrucoes que armazenam e recuperam o estado da pilha com o STMFD.
</p>

<p>
Agora, em seu codigo faca com que primeiro seja executada a instrucao indefinida e depois imprima o "Hello World" a fim de testar se o retorno do handler de undefined instruction estah funcionando. Bata um pritscreen mostrando o retorno para a instrucao seguinte a 0xffffffff para ser enviado como tarefa.
</p>
</div>
</div>

<div id="outline-container-org4e9c233" class="outline-4">
<h4 id="org4e9c233"><span class="section-number-4">9.2.7</span> modo kernel x modo usuario</h4>
<div class="outline-text-4" id="text-9-2-7">
<p>
Embora existam diversos modos no ARM, podemos classificar em usuário e o resto. Quando o ARM comeca a executar está em modo supervisor. Passe para o modo usuário usando MSR e tente voltar do modo usuário para supervisor também usando MSR. O que acontece? Por quê? Refaca a experiencia trocando entre modos dentro do resto (undefined, abort, supervisor, etc.). O que acontece? É possível concluir então que existem dois grandes modos: usuário e supervisor?
</p>
</div>
</div>
</div>


<div id="outline-container-org755d2f1" class="outline-3">
<h3 id="org755d2f1"><span class="section-number-3">9.3</span> Envie respondendo aas tarefas do google classroom.</h3>
<div class="outline-text-3" id="text-9-3">
</div>
<div id="outline-container-org13ce239" class="outline-4">
<h4 id="org13ce239"><span class="section-number-4">9.3.1</span> Entrega dos arquivos fontes (feito em grupo, entrega individual) + relatorio</h4>
<div class="outline-text-4" id="text-9-3-1">
<ul class="org-ul">
<li>arquivos fontes: Entregue no dia da aula os codigos fontes de cada exercicio. No cabecalho de cada codigo, escreva como o arquivo deve ser gerado. Comente o codigo para voce mesmo entender na hora da prova. Caso tenha feito algum script para geracao do codigo (recomendado), anexe o script em seu codigo. Embora o codigo seja feito em grupo, a entrega eh INDIVDUAL.</li>

<li>relatorio: Formato: pdf. Entregue ateh o final do dia aula o relatorio (pdf) cada exercicio por seu grupo, com o codigo e screenshot do tela do gdb. Embora o relatorio seja feito em grupo, a entrega eh INDIVDUAL.</li>
</ul>
</div>
</div>

<div id="outline-container-org16ccbb1" class="outline-4">
<h4 id="org16ccbb1"><span class="section-number-4">9.3.2</span> Entrega de printscreen (INDIVIDUAL)</h4>
<div class="outline-text-4" id="text-9-3-2">
<p>
Bata um printscreen mostrando o retorno para a instrucao seguinte a 0xffffffff (instrucao invalida) para ser enviado como tarefa; ou seja, mostre que o handler que trata de instrucao invalida retorna corretamente.
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org6b83038" class="outline-2">
<h2 id="org6b83038"><span class="section-number-2">10</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-07-15 qui&gt; </span></span> . E10: interrupcao de tempo no Versatile emulado.</h2>
<div class="outline-text-2" id="text-10">
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc36cddc">10.1. Planejamento (individual):</a></li>
<li><a href="#orgb398d4e">10.2. Experiencia:</a></li>
<li><a href="#org9dc8649">10.3. Geracao do código e como se roda.</a></li>
<li><a href="#org9bdbc26">10.4. Observacao sobre o codigo</a>
<ul>
<li><a href="#org2aaad56">10.4.1. teste do INTPND</a></li>
</ul>
</li>
<li><a href="#orgba18f08">10.5. Corrija os ERROS na apostila</a>
<ul>
<li><a href="#org4b57ea8">10.5.1. O código da apostila não inicializa adequadamente as pilhas na placa versatile</a></li>
<li><a href="#org259b80c">10.5.2. O retorno de IRQ é feito de forma ERRADA</a></li>
<li><a href="#org1ae5f76">10.5.3. Problema ao recuperar o cpsr anterior</a></li>
<li><a href="#orgf4f44be">10.5.4. Polemica - BNE x BLNE</a></li>
</ul>
</li>
<li><a href="#orge1a08bc">10.6. Observe e faça pequenas alteracoes no codigo em assembly</a>
<ul>
<li><a href="#org39645d0">10.6.1. examine no debuguer:</a></li>
<li><a href="#org9c1f435">10.6.2. desabilite as instrucoes</a></li>
<li><a href="#org345d863">10.6.3. endereco do vetor de interrupcao</a></li>
<li><a href="#org7467ba8">10.6.4. timer, inicializacao</a></li>
<li><a href="#orgc132aba">10.6.5. Fazendo o tratamento da interrupcao em C.</a></li>
</ul>
</li>
<li><a href="#org614860d">10.7. Envie respondendo aas tarefas do google classroom.</a>
<ul>
<li><a href="#orgc1eb667">10.7.1. Entrega de relatorio e dos arquivos fontes (feito em grupo, entrega individual)</a></li>
<li><a href="#org0b78d9f">10.7.2. Entrega de printscreen (INDIVIDUAL)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgc36cddc" class="outline-3">
<h3 id="orgc36cddc"><span class="section-number-3">10.1</span> Planejamento (individual):</h3>
<div class="outline-text-3" id="text-10-1">
<ul class="org-ul">
<li>Estude partes do código em <a href="http://www.pcs.usp.br/~jkinoshi/2012/exp-int-versatile.pdf">http://www.pcs.usp.br/~jkinoshi/2012/exp-int-versatile.pdf</a></li>
<li>Junte o código em irq.s e compile.</li>
<li>Em um pdf :</li>
</ul>
<p>
&#x2013; Mostre irq.s e Comente as partes em que o código está dividido e o que faz cada parte.
&#x2013; Como o timer eh programado? Como se define o intervalo entre interrupcoes?
&#x2013; Para que servem os registradores do timer e onde sao utilizados no programa (inicializacao no progama principal ou interrupt handler)?
TIMER0L - load
TIMER0V - value
TIMER0C - control
TIMER0X - clear
&#x2013; Para que servem os registradores da controladora de interrupcao e onde sao utilizados no programa (inicializacao no progama principal ou interrupt handler)?
INTEN - enable
INTPND - status
INTSEL - select (FIQ, IRQ)
</p>

<p>
&#x2013; O que significa:
</p>
<pre class="example">
LDR r0, INTEN
LDR r1,=0x10 @bit 4 for timer 0 interrupt enable
STR r1,[r0]
</pre>
</div>
</div>


<div id="outline-container-orgb398d4e" class="outline-3">
<h3 id="orgb398d4e"><span class="section-number-3">10.2</span> Experiencia:</h3>
<div class="outline-text-3" id="text-10-2">
<p>
No ano de 2011, a equipe do Lucas Estevam fez o seguinte documento:
<a href="http://www.pcs.usp.br/~jkinoshi/2012/exp-int-versatile.pdf">http://www.pcs.usp.br/~jkinoshi/2012/exp-int-versatile.pdf</a>
Este relatório possui várias coisas interessantes:
</p>
<ol class="org-ol">
<li>qemu emulando uma placa versatile sem nada - sem linux, etc.</li>
<li>o firmware que programa a interrupcao de timer da placa, cria o vetor de interrupcao, faz o vetor de interrupcao apontar para a rotina de tratamento de interrupcao, dispara o timer de forma a gerar a interrupcao. A rotina de interrupcao limpa o pedido de interrupcao.</li>
<li>o ld-script permite que aloquemos código em posicoes fixas, em particular, na posicao definida pela ARM para o vetor de interrupcao.</li>
<li>Eles nao estao usando o tootle chain que vimos na aula passada arm-none-eabi e sim o que usamos ao longo das aulas que foi o arm-elf. Ao lerem a apostila usem sempre o arm-none-eabi e em especial, arm-none-eabi-ld.</li>
</ol>

<p>
O objetivo da aula é:
</p>
<ul class="org-ul">
<li>observar o vetor de interrupcao definido pela ARM.</li>
<li>observar como é feita a programacao do timer.</li>
<li>observar como as interrupcoes sao habilitadas.</li>
<li>observar como o pedido de interrupcao eh abaixado na rotina de interrupcao.</li>
<li>observar como funciona o modo usuario e o modo supervisor e consequentemente como as pilhas de usuario e supervisor sao utilizadas.</li>
</ul>


<p>
Na aula:
</p>
<ul class="org-ul">
<li>Crie um relatorio em texto para ser enviado via email com o subject "labmicro E10" no final da aula:</li>
</ul>
</div>
</div>

<div id="outline-container-org9dc8649" class="outline-3">
<h3 id="org9dc8649"><span class="section-number-3">10.3</span> Geracao do código e como se roda.</h3>
<div class="outline-text-3" id="text-10-3">
<ul class="org-ul">
<li>Gere o código usando arm-none-eabi. Nao use  arm-none-linux-eabi e qualquer outro toolchain. Usando os alias, voce pode gerar assim:</li>
</ul>
<pre class="example">
eabi-as irq.s -o irq.o
eabi-ld -T irqld.ld irq.o -o irq.elf
eabi-bin irq.elf irq.bin
</pre>



<p>
Observe dois alias para rodar o codigo:
</p>
<pre class="example">
alias qemu='qemu-system-arm -M versatilepb -m 128M -nographic -s -S -kernel'
alias eabi-qemu='arm-none-eabi-gdb -tui --command=/home/student/.gdbinit/qemu'
</pre>

<p>
Assim, rode em um terminal:
</p>
<pre class="example">
qemu irq.bin
</pre>

<p>
e em outro terminal:
</p>
<pre class="example">
eabi-qemu -se irq.elf
</pre>

<p>
Experimente rodar o codigo da apostila dentro do gdb, observando se cai na interrupcao de hardware fazendo algo do tipo:
</p>
<pre class="example">
b main
r
b do_irq_interrupt
c
</pre>
<p>
Obs: Voce nao cairah na interrupcao apenas fazendo step (s) ou next (n); use o continue (c); nao use run (r) depois de cair no main.
</p>


<p>
Muito provavelmente voce deve cair no "do<sub>irq</sub><sub>interrupt</sub>", porem, se voce fez tudo corretamente (tem certeza que o codigo fonte estah correto?), entao existe uma pequena possibilidade de que a pilha tenha sido inicializada de forma errada como estah escrito no topico abaixo "Corrija os ERROS na apostila". Se depois do corrigir a inicializacao das pilhas, o seu codigo nao interromper eh porque ele deve estar errado (copiado errado ou pilha nao inicializada) ou foi gerado errado.
</p>
</div>
</div>


<div id="outline-container-org9bdbc26" class="outline-3">
<h3 id="org9bdbc26"><span class="section-number-3">10.4</span> Observacao sobre o codigo</h3>
<div class="outline-text-3" id="text-10-4">
</div>
<div id="outline-container-org2aaad56" class="outline-4">
<h4 id="org2aaad56"><span class="section-number-4">10.4.1</span> teste do INTPND</h4>
<div class="outline-text-4" id="text-10-4-1">
<p>
TST r0, #0x0010 @verifica se é uma interupção de timer
BNE handler<sub>timer</sub> @vai para o rotina de tratamento da interupção de timer 
</p>

<p>
A instrucao TST faz o ANDS bit a bit e seta a flag Z (usada pelo BNE) caso o resultado seja zero. O importante eh olhar se o bit estah setado. Se estiver, entao o resultado nao eh zero e por isso eh feito o desvio para o handler<sub>timer</sub>.
</p>
</div>
</div>
</div>

<div id="outline-container-orgba18f08" class="outline-3">
<h3 id="orgba18f08"><span class="section-number-3">10.5</span> Corrija os ERROS na apostila</h3>
<div class="outline-text-3" id="text-10-5">
</div>
<div id="outline-container-org4b57ea8" class="outline-4">
<h4 id="org4b57ea8"><span class="section-number-4">10.5.1</span> O código da apostila não inicializa adequadamente as pilhas na placa versatile</h4>
<div class="outline-text-4" id="text-10-5-1">
<p>
As pilhas no modo supervisor e no modo IRQ nao sao inicializadas. Com base na experiência da aula passada, ajuste isso; usando MSR. Se voce nao fizer isso, terah problemas graves ao ocorrerem as interrupcoes porque o codigo nao vai retornar para a posicao certa antes da interrupcao. 
</p>
</div>
</div>

<div id="outline-container-org259b80c" class="outline-4">
<h4 id="org259b80c"><span class="section-number-4">10.5.2</span> O retorno de IRQ é feito de forma ERRADA</h4>
<div class="outline-text-4" id="text-10-5-2">
<p>
Observe o codigo
</p>
<pre class="example">
do_irq_interrupt: @Rotina de interrupções IRQ
   STMFD sp!, {r0 - r3, LR}
   @Empilha os registradores
   LDR r0, INTPND @Carrega o registrador de status de interrupção 
   LDR r0, [r0]
   TST r0, #0x0010 @verifica se é uma interupção de timer
   BNE handler_timer @vai para o rotina de tratamento da interupção de timer
   LDMFD sp!, {r0 - r3,lr}
   mov pc, r14
   @retorna
</pre>

<p>
O retorno do IRQ está errado em:
</p>
<pre class="example">
mov pc, r14
</pre>

<p>
r14 é o LR.
O LR é automaticamente setado pelo processador ARM quando ocorre a IRQ; porém da seguinte forma:
LR = endereco<sub>de</sub><sub>retorno</sub> + 4
devido ao pipeline. Para resolver isso é necessário fazer retirar 4 de LR.
</p>

<ul class="org-ul">
<li>Obs - logo ao entrar na rotina de interrupcao, observe para qual instrucao o LR aponta atraves de:</li>
</ul>
<pre class="example">
x/i $lr
</pre>
<p>
depois de subtrair 4 de LR, observe novamente
</p>
<pre class="example">
x/i $lr
</pre>
<p>
Agora faz sentido? 
Isso ocorre por que a propria ARM define assim; meu chute eh pelo pipeline que andou no irq, mas nao andou no undefined (visto na aula passada). 
</p>
</div>
</div>

<div id="outline-container-org1ae5f76" class="outline-4">
<h4 id="org1ae5f76"><span class="section-number-4">10.5.3</span> Problema ao recuperar o cpsr anterior</h4>
<div class="outline-text-4" id="text-10-5-3">
<p>
As duas instruções:
</p>
<pre class="example">
LDMFD sp!, {r0 - r3,lr}
mov pc, r14
</pre>

<p>
não recuperam o cpsr anterior. Isso acarreta um problema. O CPSR contém um bit que diz se o processador atende as interrupcoes IRQ ou não. Logo quando ocorre a interrupcao o bit I do cpsr eh zerado para desabilitar que uma interrupcao ocorra dentro de outra. Como o CPSR nao retorna ao valor anterior, ele permanece com as interrupcoes desabilitadas.
Com base nessa informacao, altere o código de forma a que a rotina de interrupcao IRQ TERMINE com:
</p>
<pre class="example">
LDMFD sp!,{R0-R12,pc}^
</pre>

<p>
como vimos na aula passada e explicado em 
<a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0471c/Ciheidgb.html">http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0471c/Ciheidgb.html</a>
</p>

<ul class="org-ul">
<li>Obs1: vários alunos trocaram a instrucao  LDMFD sp!,{R0-R12,pc}^ por algo como  LDMFD sp!,{R0-R12,lr}^ e depois alteraram o pc. Isso nao funciona pois o modo de operacao (e pilhas e backed registers) jah foram alterados. Eh obrigatorio executar LDMFD sp!,{R0-R12,pc}^ para retornar da rotina de interrupcao.</li>

<li>Obs2: Se sua equipe nao estiver conseguindo retornar da interrupcao rodando  LDMFD sp!,{R0-R12,pc}^ observe a pilha. Coloque um breakpoint nessa instrucao e examine como estah a pilha observando o sp. Os valores que estao na pilha correspondem aos que serao colocados nos registradores, e em especial no pc? O retorno deve ser para o loop infinito do programa principal. Esse endereco de retorno estah de fato na pilha? Ao observar o endereco de retorno na pilha, voce pode observar a instrucao que serah executada atraves do comando do debugger x/i ENDERECO.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf4f44be" class="outline-4">
<h4 id="orgf4f44be"><span class="section-number-4">10.5.4</span> Polemica - BNE x BLNE</h4>
<div class="outline-text-4" id="text-10-5-4">
<p>
Alguns alunos consideraram que o mais correto eh usar BLNE ao inves de BNE.
Isso nao eh necessario, depende de como handler<sub>timer</sub> retorna. A ideia da apostila era retornar para o loop do programa principal diretamente, portanto nao cosideramos isso como um erro da apostila. Contudo, o codigo da apostila nao estah elegante. O melhor eh fazer como no codigo abaixo usando BLNE e fazer handler<sub>timer</sub> retornar para quem chamou ao inves de fazer LDMFD.
</p>

<pre class="example">
do_irq_interrupt: @Rotina de interrupções IRQ
   STMFD sp!, {r0 - r3, LR}
   @Empilha os registradores
   LDR r0, INTPND @Carrega o registrador de status de interrupção 
   LDR r0, [r0]
   TST r0, #0x0010 @verifica se é uma interupção de timer
   BLNE handler_timer @vai para o rotina de tratamento da interupção de timer
   LDMFD sp!, {r0 - r3,lr}
   mov pc, r14    @retorna
</pre>
</div>
</div>
</div>

<div id="outline-container-orge1a08bc" class="outline-3">
<h3 id="orge1a08bc"><span class="section-number-3">10.6</span> Observe e faça pequenas alteracoes no codigo em assembly</h3>
<div class="outline-text-3" id="text-10-6">
</div>
<div id="outline-container-org39645d0" class="outline-4">
<h4 id="org39645d0"><span class="section-number-4">10.6.1</span> examine no debuguer:</h4>
<div class="outline-text-4" id="text-10-6-1">
<ul class="org-ul">
<li>debugue o codigo: rode até a instrucao  LDMFD sp!,{R0-R12,pc}^ e examine a pilha. Verifique se o valor a ser carregado em PC está correto.</li>

<li>Coloque um breakpoint logo no início da interrupcao de timer, o mais perto possivel do vetor de interrupcao, e rode até lá. Qual é o modo em que o processador roda? Qual é o sp? O que se vê na pilha? Relacione o PC que deveria apontar para a instrucao seguinte antes de ocorrer a interrupcao com o LR (veja que tem uma diferenca de 4 bytes).</li>

<li>Como o processador chaveia de modo ao sair da rotina de interrupcao? Verifique isso localizando a instrucao que faz isso. Quando estamos debugando passo a passo e observamos que o processador sai da rotina de interrupcao, pode acontecer do timer da maquina virtual continuar marcando o tempo e como nós seres humanos somos muito mais lentos que a máquina, é bem provável que logo ao sair da rotina de interrupcao, já tenha ocorrido outra interrupcao de timer. Verifique se isso acontece.</li>
</ul>
</div>
</div>


<div id="outline-container-org9c1f435" class="outline-4">
<h4 id="org9c1f435"><span class="section-number-4">10.6.2</span> desabilite as instrucoes</h4>
<div class="outline-text-4" id="text-10-6-2">
<ul class="org-ul">
<li>Qual é a instrucao que habilita as interrupcoes? Desabilite as interrupcoes no cpsr e rode. O que acontece? Voce acha razoavel habilitar as interrupcoes enquanto se programa o timer? De fato isso nao eh razoavel, primeiro deve-se programar o timer para depois habilitar as interrupcoes. Isto eh: alterar cpsr zerando o bit I deve ser a ultima operacao a ser feita. Altere isso no codigo. Veja se funciona.</li>
<li>Se tudo estiver correto, anexe esse código no email a ser enviado ao professor.</li>
</ul>
</div>
</div>


<div id="outline-container-org345d863" class="outline-4">
<h4 id="org345d863"><span class="section-number-4">10.6.3</span> endereco do vetor de interrupcao</h4>
<div class="outline-text-4" id="text-10-6-3">
<ul class="org-ul">
<li>Como o código definiu o vetor de interrupcao? Responda relacionando com o ARM e o ldscript.</li>
</ul>
</div>
</div>


<div id="outline-container-org7467ba8" class="outline-4">
<h4 id="org7467ba8"><span class="section-number-4">10.6.4</span> timer, inicializacao</h4>
<div class="outline-text-4" id="text-10-6-4">
<ul class="org-ul">
<li>Observe como foi feita a programacao do timer em timer<sub>init</sub>. A apostila faz</li>
</ul>

<pre class="example">
timer_init:
 mrs r0, cpsr
 bic r0,r0,#0x80
 msr cpsr_c,r0 @enabling interrupts in the cpsr
 LDR r0, INTEN
 LDR r1,=0x10 @bit 4 for timer 0 interrupt enable
 STR r1,[r0]
 LDR r0, TIMER0C
 LDR r1, [r0]
 MOV r1, #0xA0 @enable timer module
 STR r1, [r0]
 LDR r0, TIMER0V
 MOV r1, #0xff @setting timer value
 STR r1,[r0]
 mov pc, lr
</pre>

<p>
mais especificamente:
</p>


<pre class="example">
LDR r0, TIMER0V
MOV r1, #0xff @setting timer value
STR r1,[r0]
</pre>

<p>
Isso nao estah de acordo com a documentacao em <a href="http://infocenter.arm.com/help/topic/com.arm.doc.ddi0271d/DDI0271.pdf">http://infocenter.arm.com/help/topic/com.arm.doc.ddi0271d/DDI0271.pdf</a> 
pois o registrador TIMER0V eh para se ler o valor do timer, enquanto o registrador TIMER0L eh para se fazer a carga do valor inicial. Assim, consideramos que a programacao correta do timer deveria ser:
</p>

<pre class="example">
LDR r0, TIMER0L
MOV r1, #0xff @setting timer value
STR r1,[r0]
</pre>


<ul class="org-ul">
<li>Qual é o modo em que o processador roda logo no início enquanto o timer está sendo configurado? Qual registrador deve ser observado? Qual é sp utilizado?</li>
</ul>

<p>
O Mitsuo/2018 pensou no modo e na sequencia de programacao do timer, de tal forma que a alteracao do TIMER0L, altera o intervalo das interrupcoes. Troque o timer<sub>init</sub> no seu codigo pelo codigo abaixo e faca experiencias alterando o valor de TIMER0L.
</p>
<pre class="example">
timer_init:
 LDR r0, INTEN
 LDR r1,=0x10 @bit 4 for timer 0 interrupt enable
 STR r1,[r0]
 LDR r0, TIMER0L
 LDR r1, =0xffffff @setting timer value
 STR r1,[r0]
 LDR r0, TIMER0C
 MOV r1, #0xE0 @enable timer module
 STR r1, [r0]
 mrs r0, cpsr
 bic r0,r0,#0x80
 msr cpsr_c,r0 @enabling interrupts in the cpsr
 mov pc, lr
</pre>

<p>
Obs: o timer pode ser configurado como "periodic" (interrompe de tempo em tempo) ou "free running" (interrompe apenas uma vez). O valor para periodic no site estah como 1, mas a equipe do Elton,Helio,Mafra-19 observaram que ocorre o contrario: o valor para periodic deve ser zero. Essa disnticao entre "free running" e "periodic"  funciona ao usar o registrador TIMER0V. Quando o registrador TIMER0L recebe um valor, entao, sempre interrompe periodicamente.
</p>
</div>
</div>

<div id="outline-container-orgc132aba" class="outline-4">
<h4 id="orgc132aba"><span class="section-number-4">10.6.5</span> Fazendo o tratamento da interrupcao em C.</h4>
<div class="outline-text-4" id="text-10-6-5">
<p>
O código está todo em assembly, mas é possível codificar parte dele em C. Para isso precisamos de seguir diversos passos: 
</p>

<ul class="org-ul">
<li>observe o código de handler<sub>timer</sub>:</li>
</ul>

<pre class="example">
handler_timer:
	LDR r0, TIMER0X
	MOV r1, #0x0
	STR r1, [r0] @clear timer interrupt

	@ do whatever you want with the timer here

	LDMFD   sp!, {r0 - r3,lr}	 
	mov pc, r14
</pre>

<p>
A instrucao mov pc, r14 corresponde ao retorno de do<sub>irq</sub><sub>interrupt</sub> (feito de forma errada) e não de handler<sub>timer</sub>. 
</p>

<ul class="org-ul">
<li>Altere o código assembly para que handler<sub>timer</sub> seja uma rotina chamada em do<sub>irq</sub><sub>interrupt</sub> através de:</li>
</ul>
<p>
BLNE handler<sub>timer</sub>; ou seja, handler<sub>timer</sub> deverá se comportar como uma rotina normal que retorna para quem a chamou (e nao como um endereco para onde o codigo eh desviado e nao retorna). Verifique usando o qemu+gdb se voce consegue entrar na rotina handler<sub>timer</sub>. 
</p>

<ul class="org-ul">
<li>Crie dois arquivos assembly irq.s e handler.s contendo handler<sub>timer</sub>; verifique se funciona, observando duas ou mais interrupcoes de relogio e observe se o sp não está variando a cada chamada - se não está gradativamente empilhando coisas.</li>
</ul>
<p>
Observe que ao linkar, a ordem com que se colocam os objetos irq.o e handler.o eh extremamente importante. Deve-se colocar primeiro o codigo que contenha o vetor de interrupcao.  
</p>

<ul class="org-ul">
<li>Depois recodifique handler<sub>timer</sub> em C. Ao fazer isso, declare um pointer em C referente a TIMER0X de forma a colocar o valor zero nessa posicao de memoria a fim de baixar o pedido de interrupcao. Nao eh preciso aproveitar a definicao de TIMER0X do assembly; eh muito mais facil declarar o ponteiro direto em C.</li>
</ul>
<p>
Obs: para exportar o nome handler<sub>timer</sub> eh necessario usar .global
</p>


<ul class="org-ul">
<li>A partir de agora, ao ativar o qemu retire a opcao que "mata" a serial: -serial /dev/null, pois caso contrário, voce não verá os caracteres na tela.</li>

<li>Misture o codigo dessa experiencia com a da aula passada a fim de que o programa imprima uma vez "Hello World" no program principal, antes mesmo de programar o timer.</li>

<li>Usando a experiência passada, faça com que o handler<sub>timer</sub> em C imprima o digito "#" a cada interrupcao.</li>

<li>Altere o programa principal para que ele fique em um loop continuamente imprimindo o digito " " (espaco) de tempo em tempo (fique em um loop para gastar tempo). Assim, na tela voce deverá ver " "s e "#"s intercalados. IMPORTANTE: tire um printscreen dos ' 's e '#' sendo impressos para entregar ao professor como atividade.</li>

<li>O que acontece se nao retirarmos o pedido de interrupcao na rotina que trata a interrupcao? Experimente deixando o programa rodar e explique. A frequencia com que os caracteres sao impressos varia se nao retirarmos o pedido de interrupcao? Ou seja, a relacao entre " "s e "#"s foi alterada? Explique no relatorio. Rode o programa de uma vez sem breakpoints. Em pelo menos uma equipe, aconteceu do resultado ser diferente rodando passo a passo pois nesse caso, o 1 e 2 eram intercalados enquanto que rodando de uma vez o resultado era o esperado (somente a rotina de interrupcao imprimia).</li>
</ul>
</div>
</div>
</div>




<div id="outline-container-org614860d" class="outline-3">
<h3 id="org614860d"><span class="section-number-3">10.7</span> Envie respondendo aas tarefas do google classroom.</h3>
<div class="outline-text-3" id="text-10-7">
</div>
<div id="outline-container-orgc1eb667" class="outline-4">
<h4 id="orgc1eb667"><span class="section-number-4">10.7.1</span> Entrega de relatorio e dos arquivos fontes (feito em grupo, entrega individual)</h4>
<div class="outline-text-4" id="text-10-7-1">
<ul class="org-ul">
<li>codigos fontes (*.s, *.c): Entregue no dia da aula os codigos fontes de cada exercicio. No cabecalho de cada codigo, escreva como o arquivo deve ser gerado. Comente o codigo para voce mesmo entender na hora da prova. Caso tenha feito algum script para geracao do codigo (recomendado), anexe o script em seu codigo. Embora o codigo seja feito em grupo, a entrega eh INDIVDUAL.</li>

<li>relatorio: Formato: .pdf. Entregue o relatorio (pdf) contendo codigo e screenshot da tela do gdb. Embora o relatorio seja feito em grupo, a entrega eh INDIVDUAL.</li>
</ul>
</div>
</div>

<div id="outline-container-org0b78d9f" class="outline-4">
<h4 id="org0b78d9f"><span class="section-number-4">10.7.2</span> Entrega de printscreen (INDIVIDUAL)</h4>
<div class="outline-text-4" id="text-10-7-2">
<p>
No item "Fazendo o tratamento da interrupcao em C." pede-se que o aluno tire um printscreen da tela contendo o "#", impresso quando ocorre a interrupcao e espacos e " "s impresso no loop principal. Faca o upload mosrando isso na tela de seu computador.
</p>
</div>
</div>
</div>
</div>



<div id="outline-container-orgbb53af7" class="outline-2">
<h2 id="orgbb53af7"><span class="section-number-2">11</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-07-22 qui&gt; </span></span> . E11: Chaveamento entre 2 processos.</h2>
<div class="outline-text-2" id="text-11">
<div id="text-table-of-contents">
<ul>
<li><a href="#org61a608a">11.1. Planejamento (individual):</a></li>
<li><a href="#orgb7ab140">11.2. Objetivo:</a></li>
<li><a href="#org593dec7">11.3. Envie respondendo aas tarefas do google classroom.</a>
<ul>
<li><a href="#orgc8241de">11.3.1. Entrega dos arquivos fontes + relatorio (feito em grupo, entrega individual)</a></li>
<li><a href="#org784a9a3">11.3.2. Entrega de printscreen (INDIVIDUAL)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org61a608a" class="outline-3">
<h3 id="org61a608a"><span class="section-number-3">11.1</span> Planejamento (individual):</h3>
<div class="outline-text-3" id="text-11-1">
<p>
Escreva o codigo de um programa que salva e recupera todos os registradores, inclusive PC, SP, LR e CPSR do processo que sofreu a interrupção e entregue esse codigo (em texto ou pdf; ou mesmo escrito a mao, mas lembre-se que voce deve rodar o codigo - ver abaixo - e alem disso, o seu codigo vai ser aproveitado na aula por isso acho que o pdf ou texto dessa vez eh melhor) ao retornar essa atividade no google classroom. 
</p>

<p>
Para isso:
</p>
<ul class="org-ul">
<li>caso seu grupo nao tenha rodado a experiencia da aula passada, continue ateh ver os "#"s (da interrupacao) e " "s (do programa principal) intercalados.</li>

<li>Crie uma estrutura de dados (um espaco na memoria), linhaA, onde voce deverah salvar todos os registradores r0-r12 ao entrar e sair da rotina de interrupcao. Rode e teste isso em casa.</li>

<li>Aumente essa estrutura de dados para armazenar os outros registradores: PC do programa principal, LR do programa principal, SP do programa principal e CPSR do programa principal. 
Os outros registradores LR, SP, PC e CPSR provém de fonte diferente (veja: <a href="http://aelmahmoudy.users.sourceforge.net/electronix/arm/chapter3.htm">http://aelmahmoudy.users.sourceforge.net/electronix/arm/chapter3.htm</a>)</li>
<li>- CPSR/supervisor está salvo em SPSR/IRQ.</li>

<li>- PC/supervisor está salvo em LR/IRQ; melhor dizendo: PC/supervisor = LR/irq - 4</li>
</ul>
<p>
Obtenha esses registradores e armazena em linhaA. Uma ideia eh, logo ao entrar na interrupcao de relogio, salvar o PC do processo, ou seja, salvar LR/IRQ -4 (pode ser em memoria numa variavel declarada por voce), liberando LR para outros usos. 
</p>

<ol class="org-ol">
<li>- LR e SP são banked registeres (ver pag 1.7 da apostila Lab Manual).</li>
</ol>
<p>
Para obter o LR e o SP do modo supervisor use as instrucoes que alteram o modo do processador
MRS R0,CPSR           ; or SPSR
MSR CPSR,R0           ; or SPSR 
</p>

<p>
Tome cuidado ao usar MSR e MRS pois, ao chavear de modo, vc. pode acabar sujando registradores como o spsr; alem disso, lembre-se que o CPSR contem o bit I onde zero em I habilita as interrupcoes. Voce deverah alterar os modos para pegar LR e SP com as interrupcoes desabilitadas. Coloque os bits I e F em 1 (desabilitando as interrupcoes) na posicao correspondente em R0 ao fazer  MSR CPSR,R0
</p>

<p>
linhA eh uma estrutura que possui 17 registradores (R0-15 + cpsr) de 4 bytes, portanto possui 17*4 = 68 bytes. Cada um dos registradores da taskA poderia ser acessado individualmente. Por exemplo: R0 estah em linhaA, R1 em linhaA+4 e assim por diante. 
</p>

<ul class="org-ul">
<li>Reescreva o código de forma que na interrupcao de relogio, salve todos os registradores (incluindo LR, SP, PC, CPSR) e os recupere (como se fosse o chaveamento de um processo apenas).</li>

<li>Compile e execute o código em casa. Observe os '#"s e ' 's sendo impressos como acontecia na aula de interrupcao.</li>
<li>tire um pritscreen dessa tela e anexe no planejamento.</li>
</ul>
<p>
Apresente o programa rodando no comeco da aula para o professor.
</p>
</div>
</div>


<div id="outline-container-orgb7ab140" class="outline-3">
<h3 id="orgb7ab140"><span class="section-number-3">11.2</span> Objetivo:</h3>
<div class="outline-text-3" id="text-11-2">
<ul class="org-ul">
<li>Usar a interrupcao do timer para chavear entre duas tarefas. Crie uma taskA que continuamente imprime "1" e uma taskB que imprime "2".</li>
<li>Observe que o processo nao deve saber de nenhuma informacao do nosso "nanokernel" como onde sua pilha eh inicializada, a variavel nproc (numero do processo), linhaA ou linhaB.</li>
</ul>

<p>
O pseudo codigo de taskA deve ser algo como:
</p>

<pre class="example">
void taskA() {
  while(1) {
     print("1");
  }
}
</pre>

<p>
Vamos criar um nanokernel que faz esse chaveamento: 
</p>
<ul class="org-ul">
<li>carregue o vetor de interrupcao.</li>
<li>No reset, faca a inicializacao da controladora de interrupcoes e do timer.</li>
<li>A rotina de interrupcao do timer deve fazer o chaveamento entre as tarefas; para isso ela deverá salvar o estado do processo corrente em uma estrutura de dados que vamos chamar de tabela de processos. Ao sair da rotina de interrupcao, os registradores do outro processo devem ser recuperados.</li>
</ul>

<p>
Para isso:
</p>
<ul class="org-ul">
<li>Rode o programa que voce trouxe no planejamento. Voce consegue ver todos os registradores salvos adequadamente? Consegue observar a pilha do supervisor e a pilha do IRQ?</li>
<li>Além de linhaA, declare o espaco linhaB para a taskB.</li>
<li>A rotina de interrupcao deve observar o processo que estah rodando. Se for a taskA rodando, salva o estado na linha da tabela de processos da taskA e recupera o estado da linha da taskB e de forma semelhante para a taskB. Para isso, declare a variavel nproc (global) que contem o numero do processo rodando (0 para A e 1 para B).</li>
<li>reserve uma area de pilha para cada processo. Isto eh: a pilha da taskA deve estar numa posicao de memoria diferente da pilha da taskB.</li>
<li>O programa principal (correspondente a E10) deixa de ser o loop infinito. A taskA jah sai rodando logo na inicializacao. De tal forma que quando ocorrer a primeira interrupcao de tempo, a taskB passa a rodar. Ou seja, no Reset, logo depois da inicializacao, chama-se a taskA.</li>
<li>Ao ocorrer a primeira interrupcao de tempo, devemos chavear da taskA para a taskB; mas como colocar a taskB para rodar se ela nunca rodou antes? A resposta eh que basta inicilizar adequadamente os valores de linhaB fazendo com que a taskB rode normalmente. Para a taskB, deixe o SP, PC e CPSR correspondentes armazenados corretamente em linhaB. Exemplo: para inicializar o PC na linhaB deve ser fazer algo como " Store em linhaB + 60, o endereco taskB".</li>
<li>Cuidado: Inicializar o CPSR de forma errada na linhaB, com as interrupcoes desabilitadas, irah 'travar' tudo.</li>
<li>Inicialize o SP na linhaB de forma que a pilha de taskA e a pilha de taskB caiam em posicoes de memoria diferentes.</li>
<li>Ao rodar o programa, é de se esperar que saiam "1"s e "2"s intercalados.</li>
</ul>

<p>
Dicas para o debug:
</p>
<ul class="org-ul">
<li>verifique a cada interrupcao de relogio se o ponteiro de pilha (do modo interrupt) estah sempre no mesmo nivel. Caso isso nao ocorra, dados podem estar sendo acumulados na pilha. Se a pilha do modo interrupt nao estiver empilhando e desempilhando adequadamente, deve acontecer que, depois do programa estiver rodando por um certo tempo, ele trava.</li>
<li>a cada interrupcao de relogio, aproveite para ver o nivel das pilhas dos outros processos. Verifique se elas estao em posicoes diferentes e se estao acumulando bytes a cada interrupcao.</li>
</ul>
</div>
</div>


<div id="outline-container-org593dec7" class="outline-3">
<h3 id="org593dec7"><span class="section-number-3">11.3</span> Envie respondendo aas tarefas do google classroom.</h3>
<div class="outline-text-3" id="text-11-3">
</div>
<div id="outline-container-orgc8241de" class="outline-4">
<h4 id="orgc8241de"><span class="section-number-4">11.3.1</span> Entrega dos arquivos fontes + relatorio (feito em grupo, entrega individual)</h4>
<div class="outline-text-4" id="text-11-3-1">
<ul class="org-ul">
<li>fontes (*.s, *.c) Entregue no dia da aula os codigos fontes de cada exercicio. No cabecalho de cada codigo, escreva como o arquivo deve ser gerado. Comente o codigo para voce mesmo entender na hora da prova. Caso tenha feito algum script para geracao do codigo (recomendado), anexe o script em seu codigo. Embora o codigo seja feito em grupo, a entrega eh INDIVDUAL.</li>

<li>relatorio Formato: pdf. Entregue o relatorio (pdf) contendo codigo e screenshot da tela do gdb. Embora o relatorio seja feito em grupo, a entrega eh INDIVDUAL.</li>
</ul>
</div>
</div>

<div id="outline-container-org784a9a3" class="outline-4">
<h4 id="org784a9a3"><span class="section-number-4">11.3.2</span> Entrega de printscreen (INDIVIDUAL)</h4>
<div class="outline-text-4" id="text-11-3-2">
<ul class="org-ul">
<li>Altere a taskA para imprimir seu nome e a taskB para imprimir seu NUSP.</li>
</ul>
<p>
No item "Fazendo o tratamento da interrupcao em C." pede-se que o aluno tire um printscreen do seu nome intercalado com seu NUSP sendo impressos pelos 2 processos, com os '#' a cada interrupcao. Faca o upload mosrando isso na tela de seu computador.
</p>
<ul class="org-ul">
<li>apresente ao professor no final da aula.</li>
</ul>
</div>
</div>
</div>
</div>


<div id="outline-container-org71d684b" class="outline-2">
<h2 id="org71d684b"><span class="section-number-2">12</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-07-29 qui&gt; </span></span> . E12: Preparar projeto do curso a ser entregue ou terminar o chaveamento entre 2 processos.</h2>
</div>








<div id="outline-container-orge222e91" class="outline-2">
<h2 id="orge222e91"><span class="section-number-2">13</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-08-05 qui&gt; </span></span> . E13: Preparar projeto do curso a ser entregue ou terminar o chaveamento entre 2 processos.</h2>
</div>

<div id="outline-container-org0890049" class="outline-2">
<h2 id="org0890049"><span class="section-number-2">14</span> <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-08-12 qui&gt; </span></span> . Prova2</h2>
<div class="outline-text-2" id="text-14">
<p>
Projeto
</p>

<p>
Ideía:
Há vários anos atrás, fazia parte da avaliacao da disciplina a entrega de um trabalho que poderia ajudar o curso de labmicro e foi dessa forma, que surgiu a E11 - a experiencia que lida com a interrupcao do timer da placa Versatile emulada pelo qemu. 
</p>

<p>
O livro <a href="#org390a3b8">16.12</a> contém um pequeno kernel de um sistema operacional voltado para a placa Versatile emulada pelo qemu com código já pronto de como esses periféricos são acessados. O trabalho P2 pode ser um dos 3 casos:
</p>

<ul class="org-ul">
<li>focar num periférico (timer, teclado, uart, sd cards). Ver item abaixo: "Perifericos que interrompem (livro K C Wang)." Ex: criar uma experiencia que envolve a recepcao de dados do teclado. Criar a apostila que propoe a experiencia, informa dados sobre a programacao do periferico como portas e como deve ser feita a programacao da placa versatile para atender as interrupcoes (como a VIC deve ser programada). Esse tipo de experiencia eh bem simples de ser feito porque basicamente corresponde a rodar o código já pronto que está no livro. Esta apostila deve ser algo parecido com o da apostila na experiencia E11. Este trabalho pode envolver a equipe, mas cada aluno deve colocar no final da apostila um item próprio que ele tenha feito a fim de diferenciar dos outros membros da equipe. Este item especifico do aluno deve envolver algum codigo a ser desenvolvido. Cada aluno deve apresentar o codigo geral para a apostila como um todo e o codigo especifico da parte proposta pelo aluno.</li>

<li>focar em dois periféricos. Ex: receber dados do teclado e gravar no sd card depois que o usuario digitar control-q. Esse tipo de experiencia eh mais complexo e pode envolver a equipe inteira. Criar a apostila que propoe a experiencia, dados sobre a programacao de cada periferico como portas e como deve ser feita a programacao da placa versatile para atender as interrupcoes (programacao da VIC).</li>

<li>Nao criar apostila nenhuma, apenas rodar o codigo do cap 6 (ver item abaixo "Gerenciamento de memoria (livro K C Wang).") e criar um relatorio comentando como cada codigo foi rodado, problemas que surgiram, etc. Pode ser feito em equipe.</li>
</ul>

<p>
Cada equipe deve me retornar o que pretende fazer ateh segunda-feira. Em geral, o professor vai vetar projetos iguais (dependendo do projeto e das equipes). Por exemplo: se duas equipe escolherem o mesmo projeto de focar no teclado, entao a equipe que respondeu essa tarefa primeiro terah prioridade. Para evitar atrasos na tomada de decisao de que vai ser a P2, cada equipe deve propor 3 temas na esperanca de que nenhuma equipe tenha pego algum dos temas previamente.
</p>

<p>
Algumas equipes ainda nao terminaram a E11 sobre o chaveamento de processos. Espero que se dediquem e apresentem o chaveamento de processos funcionando o quanto antes a fim de que voces trabalhem na P2 durante as aulas E12 e E13.
</p>

<p>
Na aula da Prova2 estarei recebendo e avaliando os trabalhos equipe por equipe. Apresentem a apostila e o codigo rodando da experiencia proposta. 
</p>
</div>


<div id="outline-container-orgc98ea78" class="outline-3">
<h3 id="orgc98ea78"><span class="section-number-3">14.1</span> Perifericos que interrompem (livro K C Wang).</h3>
<div class="outline-text-3" id="text-14-1">
</div>
<div id="outline-container-orgf59fc06" class="outline-4">
<h4 id="orgf59fc06"><span class="section-number-4">14.1.1</span> Vectored Interrupt Controller (VIC) (basico para os outros perifericos)</h4>
<div class="outline-text-4" id="text-14-1-1">
<p>
Ver paginas 47-55. Explique: 
</p>
<ul class="org-ul">
<li>o que sao interrupcoes vetoradas e nao vetoradas,</li>
<li>como as interrupcoes podem ser habilitadas ou desabilitadas pela controladora e</li>
<li>como funciona a prioridade (quando duas ou mais interrupcoes acontecem ao mesmo tempo).</li>
</ul>
<p>
Proponha na apostila, diversas formas de programar a VIC mostrando como isso afeta a interrupcao de pelo menos dois perifericos: timer (E11) e algum outro como o teclado.
</p>
</div>
</div>

<div id="outline-container-org5e9e2bb" class="outline-4">
<h4 id="org5e9e2bb"><span class="section-number-4">14.1.2</span> timer</h4>
<div class="outline-text-4" id="text-14-1-2">
<p>
paginas 56-61
</p>
<ul class="org-ul">
<li>Observe como foi feito a interrupcao do driver e compare com a E11, anotando possiveis melhorias na E11.</li>
<li>Observe como o livro explica o uso dos registradores do timer. Estah mais claro que na apostila E11?</li>
</ul>
</div>
</div>

<div id="outline-container-org1c3904e" class="outline-4">
<h4 id="org1c3904e"><span class="section-number-4">14.1.3</span> teclado</h4>
<div class="outline-text-4" id="text-14-1-3">
<p>
pagins 61-67
</p>
</div>
</div>

<div id="outline-container-orgf88a793" class="outline-4">
<h4 id="orgf88a793"><span class="section-number-4">14.1.4</span> UART</h4>
<div class="outline-text-4" id="text-14-1-4">
<p>
pgs 67-69
</p>
</div>
</div>

<div id="outline-container-org3cf3859" class="outline-4">
<h4 id="org3cf3859"><span class="section-number-4">14.1.5</span> SD cards</h4>
<div class="outline-text-4" id="text-14-1-5">
<p>
pgs 63-74
</p>
</div>
</div>
</div>


<div id="outline-container-orge0b491e" class="outline-3">
<h3 id="orge0b491e"><span class="section-number-3">14.2</span> Gerenciamento de memoria (livro K C Wang).</h3>
<div class="outline-text-3" id="text-14-2">
<p>
pgs 169-191
</p>
</div>
</div>
</div>






<div id="outline-container-org2cb9627" class="outline-2">
<h2 id="org2cb9627"><span class="section-number-2">15</span> Avaliacao:</h2>
<div class="outline-text-2" id="text-15">
<p>
Nota Final = (Fase1 + 2*Fase2)/3
</p>

<p>
Fase1 = (E2+E3+E4+E5+E6)/5 * 0.2 + 0.8 * P1
Fase2 = (E8+E9+E10+E11)/4 * 0.2 + 0.8 * P2
</p>
</div>

<div id="outline-container-org7bdfabf" class="outline-3">
<h3 id="org7bdfabf"><span class="section-number-3">15.1</span> Avaliação por experiência:</h3>
<div class="outline-text-3" id="text-15-1">
<ul class="org-ul">
<li>planejamento: 3.0</li>
<li>aula + relatorio: 7.0</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orge317ab0" class="outline-2">
<h2 id="orge317ab0"><span class="section-number-2">16</span> Referências:</h2>
<div class="outline-text-2" id="text-16">
</div>
<div id="outline-container-orga5e5dc7" class="outline-3">
<h3 id="orga5e5dc7"><span class="section-number-3">16.1</span> ARM Laboratory Exercises - <a id="orgd64c93b"></a> - <a href="https://vdocuments.mx/arm-lab-manual-56b7b9f78a77b.html">https://vdocuments.mx/arm-lab-manual-56b7b9f78a77b.html</a></h3>
</div>
<div id="outline-container-orgc8a79d4" class="outline-3">
<h3 id="orgc8a79d4"><span class="section-number-3">16.2</span> <a id="org6672ae5"></a> - docker com gnuarm- <a href="https://github.com/EpicEric/gcc-arm">https://github.com/EpicEric/gcc-arm</a></h3>
</div>
<div id="outline-container-org574e640" class="outline-3">
<h3 id="org574e640"><span class="section-number-3">16.3</span> <a id="org4797587"></a> ARM Assembly Language Fundamentals and Techniques, William Hohl, CRC Press</h3>
</div>
<div id="outline-container-orgba0000a" class="outline-3">
<h3 id="orgba0000a"><span class="section-number-3">16.4</span> <a id="orgb8995af"></a> ARM System-on-Chip Architecture (2nd Edition), Steve Furber</h3>
</div>
<div id="outline-container-org3ce2539" class="outline-3">
<h3 id="org3ce2539"><span class="section-number-3">16.5</span> <a id="orgd34db06"></a> ARM System Developer’s Guide Designing and Optimizing System Software; Andrew N. Sloss,  Dominic Symes,  Chris Wright; Elsevier</h3>
</div>
<div id="outline-container-org0141f6a" class="outline-3">
<h3 id="org0141f6a"><span class="section-number-3">16.6</span> <a id="orga6ddfc3"></a> Linux Embarcado, Sergio Prado, <a href="https://e-labworks.com/treinamentos/linux/slides">https://e-labworks.com/treinamentos/linux/slides</a></h3>
</div>
<div id="outline-container-org27bf396" class="outline-3">
<h3 id="org27bf396"><span class="section-number-3">16.7</span> <a id="org5466d40"></a> <a href="http://www.billgatliff.com/gettingStarted.html">http://www.billgatliff.com/gettingStarted.html</a> : Uma apostila que explica o ambiente GNU para a placa evaluator 7t</h3>
</div>
<div id="outline-container-org82f87fa" class="outline-3">
<h3 id="org82f87fa"><span class="section-number-3">16.8</span> <a id="org501e09b"></a> <a href="http://www.gnu.org/manual/manual.html">http://www.gnu.org/manual/manual.html</a></h3>
</div>
<div id="outline-container-org8e353eb" class="outline-3">
<h3 id="org8e353eb"><span class="section-number-3">16.9</span> <a id="orgf3eda45"></a> <a href="http://www.microcross.com/gnu-arm7t-microcross.pdf">http://www.microcross.com/gnu-arm7t-microcross.pdf</a></h3>
</div>
<div id="outline-container-org936a477" class="outline-3">
<h3 id="org936a477"><span class="section-number-3">16.10</span> <a id="orga9e9683"></a> <a href="http://bel.gsi.de/scripts/gnu-arm-assy-quick-ref.pdf">http://bel.gsi.de/scripts/gnu-arm-assy-quick-ref.pdf</a></h3>
</div>

<div id="outline-container-orgdc8d1b4" class="outline-3">
<h3 id="orgdc8d1b4"><span class="section-number-3">16.11</span> <a id="orgc687d5e"></a> <a href="http://svr-acjf3-armie.cl.cam.ac.uk/main.cgi">http://svr-acjf3-armie.cl.cam.ac.uk/main.cgi</a></h3>
</div>



<div id="outline-container-org0c5fea2" class="outline-3">
<h3 id="org0c5fea2"><span class="section-number-3">16.12</span> <a id="org390a3b8"></a> Wang, K.C.; "Embedded and Real-Time Operating Systems", Springer; Softcover Reprint of the Original 1st 2017 ed. edição (9 setembro 2018)</h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: jk</p>
<p class="date">Created: 2021-07-23 sex 14:30</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
labmicro-21.html
Exibindo labmicro-21.html.
